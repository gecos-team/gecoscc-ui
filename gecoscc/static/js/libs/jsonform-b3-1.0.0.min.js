/*global window*/(function(e,t,n,r,i){e&&(r=require("underscore"));var s=/\[([0-9]*)\](?=\[|\.|$)/g,o={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},u={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g},a=function(e){return!r.isUndefined(e)&&!r.isNull(e)},f={util:{}},l,c,h=function(e){return a(e)?(e=""+e,e?e.replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):""):""},p=function(e){return e.replace(/([ \!\"\#\$\%\&\'\(\)\*\+\,\.\/\:\;<\=\>\?\@\[\\\]\^\`\{\|\}\~])/g,"\\$1")},d=function(e){var t=function(e,t){t.find("> .active").removeClass("active"),e.addClass("active")},r=function(e,t){e.find("input, textarea, select").removeAttr("disabled"),e.parent().children(":not([data-idx="+t+"])").find("input, textarea, select").attr("disabled","disabled")},i=function(e){var i=n("option:selected",n(this)),s=n(this),o=i.get(0).getAttribute("data-idx")||i.attr("value"),u;e.preventDefault();if(i.hasClass("active"))return;u=n(this).parents(".tabbable").eq(0).find(".tab-content [data-idx="+o+"]"),t(i,s),t(u,u.parent()),r(u,o)},s=function(e){var i=n("a",n(this)),s=n(this).parents(".tabbable").first().find(".tab-content").first(),o=n(this).index(),u=s.find("[data-idx="+o+"]");e.preventDefault(),t(n(this),n(this).parent()),t(u,u.parent()),n(this).parent().hasClass("jsonform-alternative")&&r(u,o)};e.each(function(){n(this).delegate("select.nav","change",i),n(this).find("select.nav").each(function(){n(this).val(n(this).find(".active").attr("value"));var e=n(this).find("option:selected").get(0).getAttribute("data-idx")||n(this).find("option:selected").attr("value"),t=n(this).parents(".tabbable").eq(0).find(".tab-content [data-idx="+e+"]");r(t,e)}),n(this).delegate("ul.nav li","click",s),n(this).find("ul.nav li.active").click()})};f.fieldTemplate=function(e){return'<div class="form-group jsonform-error-<%= keydash %><%= elt.htmlClass ? " " + elt.htmlClass : "" %><%= (node.schemaElement && node.schemaElement.required && (node.schemaElement.type !== "boolean") ? " jsonform-required" : "") %><%= (node.readOnly ? " jsonform-readonly" : "") %><%= (node.disabled ? " jsonform-disabled" : "") %>"><% if (node.title && !elt.notitle) { %><label class="col-sm-2 control-label" for="<%= node.id %>"><%= node.getLocalizedAttr("title") %></label><% } %><div class="<% if (!(node.title && !elt.notitle)) { print("col-sm-11 "); } else { print("col-sm-9 "); }%><% if (node.prepend || node.append) { print("input-group"); } %>"><% if (node.prepend) { %><span class="input-group-addon"><%= node.prepend %></span><% } %>'+e+"<% if (node.append) { %>"+'<span class="input-group-addon"><%= node.append %></span>'+"<% } %>"+"<% if (node.description) { %>"+'<span class="help-block"><%= node.getLocalizedAttr("description") %></span>'+"<% } %>"+"</div>"+'<span class="help-block jsonform-errortext text-danger col-sm-9 col-sm-offset-2" style="display:none;"></span>'+"</div>"};var v='<div class="_jsonform-preview"><% if (value.type=="image") { %><img class="jsonform-preview" id="jsonformpreview-<%= id %>" src="<%= value.url %>" /><% } else { %><a href="<%= value.url %>"><%= value.name %></a> (<%= Math.ceil(value.size/1024) %>kB)<% } %></div><a href="#" class="btn _jsonform-delete"><i class="icon-remove" title="Remove"></i></a> ',m=function(e){return{template:'<input type="'+e+'" '+'class="form-control <% if (fieldHtmlClass) { print(fieldHtmlClass); } %>" '+'name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"'+'<%= (node.disabled? " disabled" : "")%>'+'<%= (node.readOnly ? " readonly=\'readonly\'" : "") %>'+'<%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %>'+'<%= (node.schemaElement && node.schemaElement.required && (node.schemaElement.type !== "boolean") ? " required=\'required\'" : "") %>'+'<%= (node.placeholder? "placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%>'+" />",fieldtemplate:!0,inputfield:!0}};f.elementTypes={none:{template:""},root:{template:"<div><%= children %></div>"},text:m("text"),password:m("password"),date:m("date"),datetime:m("datetime"),"datetime-local":m("datetime-local"),email:m("email"),month:m("month"),number:m("number"),search:m("search"),tel:m("tel"),time:m("time"),url:m("url"),week:m("week"),range:{template:'<input type="range" <%= (fieldHtmlClass ? "class=\'" + fieldHtmlClass + "\' " : "") %>name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%> min=<%= range.min %> max=<%= range.max %> step=<%= range.step %><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %> />',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(e,t){e.range={min:1,max:100,step:1};if(!t||!t.schemaElement)return;t.formElement&&t.formElement.step&&(e.range.step=t.formElement.step),typeof t.schemaElement.minimum!="undefined"&&(t.schemaElement.exclusiveMinimum?e.range.min=t.schemaElement.minimum+e.range.step:e.range.min=t.schemaElement.minimum),typeof t.schemaElement.maximum!="undefined"&&(t.schemaElement.exclusiveMaximum?e.range.max=t.schemaElement.maximum+e.range.step:e.range.max=t.schemaElement.maximum)}},color:{template:'<input type="text" <%= (fieldHtmlClass ? "class=\'" + fieldHtmlClass + "\' " : "") %>name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %> />',fieldtemplate:!0,inputfield:!0,onInsert:function(e,t){n(t.el).find("#"+p(t.id)).spectrum({preferredFormat:"hex",showInput:!0})}},textarea:{template:'<textarea id="<%= id %>" name="<%= node.name %>" class="form-control" style="height:<%= elt.height || "150px" %>;width:<%= elt.width || "100%" %>;"<%= (node.disabled? " disabled" : "")%><%= (node.readOnly ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %><%= (node.placeholder? "placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%>><%= value %></textarea>',fieldtemplate:!0,inputfield:!0},wysihtml5:{template:'<textarea id="<%= id %>" name="<%= node.name %>" style="height:<%= elt.height || "300px" %>;width:<%= elt.width || "100%" %>;"<%= (node.disabled? " disabled" : "")%><%= (node.readOnly ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %><%= (node.placeholder? "placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%>><%= value %></textarea>',fieldtemplate:!0,inputfield:!0,onInsert:function(e,t){var r=function(){if(n(t.el).data("wysihtml5"))return;n(t.el).data("wysihtml5_loaded",!0),n(t.el).find("#"+p(t.id)).wysihtml5({html:!0,link:!0,"font-styles":!0,image:!0,events:{load:function(){n(this.textareaElement).removeAttr("required")}}})};if(window.jsonform_wysihtml5_setup){window.jsonform_wysihtml5_setup(r);return}var i=window.setInterval(function(){window.wysihtml5&&(window.clearInterval(i),r())},1e3)}},ace:{template:'<div id="<%= id %>" style="position:relative;height:<%= elt.height || "300px" %>;"><div id="<%= id %>__ace" style="width:<%= elt.width || "100%" %>;height:<%= elt.height || "300px" %>;"></div><input type="hidden" name="<%= node.name %>" id="<%= id %>__hidden" value="<%= escape(value) %>"/></div>',fieldtemplate:!0,inputfield:!0,onInsert:function(e,t){var i=function(){var e=t.formElement||{},i=window.ace,s=i.edit(n(t.el).find("#"+p(t.id)+"__ace").get(0)),o="#"+p(t.id)+"__hidden";s.getSession().setNewLineMode("unix"),s.renderer.setShowPrintMargin(!1),s.setTheme("ace/theme/"+(e.aceTheme||"twilight")),e.aceMode&&s.getSession().setMode("ace/mode/"+e.aceMode),s.getSession().setTabSize(2),s.getSession().setValue(t.value||"");var u=r.debounce(function(){n(t.el).find(o).val(s.getSession().getValue()),n(t.el).find(o).change()},600);s.getSession().on("change",u),s.on("blur",function(){n(t.el).find(o).change(),n(t.el).find(o).trigger("blur")}),s.on("focus",function(){n(t.el).find(o).trigger("focus")})};if(window.jsonform_ace_setup){window.jsonform_ace_setup(i);return}var s=window.setInterval(function(){window.ace&&(window.clearInterval(s),i())},1e3)}},checkbox:{template:'<div class="checkbox"><label><input type="checkbox" id="<%= id %>" name="<%= node.name %>" value="1" <% if (value) {%>checked<% } %><%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required && (node.schemaElement.type !== "boolean") ? " required=\'required\'" : "") %> /><%= node.inlinetitle || "" %></label></div>',fieldtemplate:!0,inputfield:!0,getElement:function(e){return n(e).parent().get(0)}},file:{template:'<input class="input-file" id="<%= id %>" name="<%= node.name %>" type="file" <%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %>/>',fieldtemplate:!0,inputfield:!0},"file-hosted-public":{template:"<span><% if (value && (value.type||value.url)) { %>"+v+'<% } %><input class="input-file" id="_transloadit_<%= id %>" type="file" name="<%= transloaditname %>" /><input data-transloadit-name="_transloadit_<%= transloaditname %>" type="hidden" id="<%= id %>" name="<%= node.name %>" value=\'<%= escape(JSON.stringify(node.value)) %>\' /></span>',fieldtemplate:!0,inputfield:!0,getElement:function(e){return n(e).parent().get(0)},onBeforeRender:function(e,t){t.ownerTree._transloadit_generic_public_index?t.ownerTree._transloadit_generic_public_index++:t.ownerTree._transloadit_generic_public_index=1,e.transloaditname="_transloadit_jsonform_genericupload_public_"+t.ownerTree._transloadit_generic_public_index,t.ownerTree._transloadit_generic_elts||(t.ownerTree._transloadit_generic_elts={}),t.ownerTree._transloadit_generic_elts[e.transloaditname]=t},onChange:function(e,t){if(t.ownerTree._transloadit_bound)return!1;t.ownerTree._transloadit_bound=!0;var s=n(t.ownerTree.domRoot);s.transloadit({autoSubmit:!1,wait:!0,onSuccess:function(e){var n=r.values(e.results);n=r.flatten(n),r.each(n,function(e){var n=t.ownerTree._transloadit_generic_elts[e.field].id,o=s.find("#"+p(n)),u=r.filter(r.keys(e.meta),function(t){return!!a(e.meta[t])});e.meta=r.pick(e.meta,u),o.val(i.stringify(e))}),t.ownerTree._transloadit_bound=!1,s.unbind("submit.transloadit"),r.delay(function(){console.log("submit form"),t.ownerTree.submit()},10)},onError:function(e){console.log("assembly error",e)}})},onInsert:function(e,t){n(t.el).find("a._jsonform-delete").on("click",function(e){return n(t.el).find("._jsonform-preview").remove(),n(t.el).find("a._jsonform-delete").remove(),n(t.el).find("#"+p(t.id)).val(""),e.preventDefault(),!1})},onSubmit:function(e,t){return t.ownerTree._transloadit_bound?!1:!0}},"file-transloadit":{template:"<span><% if (value && (value.type||value.url)) { %>"+v+'<% } %><input class="input-file" id="_transloadit_<%= id %>" type="file" name="_transloadit_<%= node.name %>" /><input type="hidden" id="<%= id %>" name="<%= node.name %>" value=\'<%= escape(JSON.stringify(node.value)) %>\' /></span>',fieldtemplate:!0,inputfield:!0,getElement:function(e){return n(e).parent().get(0)},onChange:function(e,t){if(t.ownerTree._transloadit_bound)return!1;t.ownerTree._transloadit_bound=!0;var s=n(t.ownerTree.domRoot);s.transloadit({autoSubmit:!1,wait:!0,onSuccess:function(e){var n=r.values(e.results);n=r.flatten(n),r.each(n,function(e){var t=s.find('input[name="'+e.field.replace(/^_transloadit_/,"")+'"]'),n=r.filter(r.keys(e.meta),function(t){return!!a(e.meta[t])});e.meta=r.pick(e.meta,n),t.val(i.stringify(e))}),t.ownerTree._transloadit_bound=!1,s.unbind("submit.transloadit"),r.delay(function(){console.log("submit form"),t.ownerTree.submit()},10)},onError:function(e){console.log("assembly error",e)}})},onInsert:function(e,t){n(t.el).find("a._jsonform-delete").on("click",function(e){return n(t.el).find("._jsonform-preview").remove(),n(t.el).find("a._jsonform-delete").remove(),n(t.el).find("#"+p(t.id)).val(""),e.preventDefault(),!1})},onSubmit:function(e,t){return t.ownerTree._transloadit_bound?!1:!0}},select:{template:'<<%= (node.parentNode.schemaElement && node.parentNode.schemaElement.autocomplete_url ? "input" : "select") %> name="<%= node.name %>" id="<%= id %>"class="form-control <% if (fieldHtmlClass) { print(fieldHtmlClass); } %>"<%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %>> <% if (!(node.parentNode.schemaElement && node.parentNode.schemaElement.autocomplete_url)) { %><% _.each(node.options, function(key, val) { if(key instanceof Object) { if (value === key.value) { %><option selected value="<%= key.value %>"><%= key.title %></option> <% } else { %> <option value="<%= key.value %>"><%= key.title %></option> <% }} else { if (value === key) { %> <option selected value="<%= key %>"><%= key %></option> <% } else { %><option value="<%= key %>"><%= key %></option><% }}}); %> <% } %> </<%= (node.parentNode.schemaElement && node.parentNode.schemaElement.autocomplete_url ? "input" : "select") %>>',fieldtemplate:!0,inputfield:!0,onInsert:function(e,t){var i=t.parentNode.schemaElement,s,o=30,u,a,f={},h="",p={};if(!i||r.isUndefined(i)||r.isUndefined(i.autocomplete_url))return;t.value?(n(t.el).addClass("hidden"),r.contains(["package_list[]","pkgs_to_remove[]"],t.formElement.name)?p={name:t.value}:p={oids:t.value},s=n.ajax({url:i.autocomplete_url,dataType:"json",data:p})):(s=n.Deferred(),s.resolve()),s.done(function(e){if(!r.isUndefined(e)){var s=e.nodes||e.packages;if(s.length===0){t.schemaElement.enum.push(t.value),n(t.el).find("input").attr("value",t.value),n(t.parentNode.el).find(".array-warning-message").removeClass("hidden");return}e=s[0]}n(t.el).find("input").html(""),n(t.el).find("input").select2({query:function(e){h.length<e.term.length&&!u?(a=r.filter(a,function(t){var n=new RegExp(e.term+".*","i");return n.test(t.text)}),f[e.term]=r.clone(a),e.callback({results:a})):f[e.term]?e.callback({results:f[e.term]}):n.ajax({url:i.autocomplete_url,dataType:"json",id:function(e){return e._id},data:{item_id:l,ou_id:c,iname:e.term,page:e.page,pagesize:o},type:"GET",success:function(n){var i=n.nodes||n.packages,s=i.map(function(e){return e._id=e._id||e.name,t.schemaElement.enum.push(e._id),{text:e.name,value:e._id,id:e._id}});u=i.length>=o,n.page===1?a=s:a=r.union(a,s),e.callback({results:s,more:u})}}),h=e.term},initSelection:function(i,s){if(!r.isUndefined(e)){n(t.el).find("input").last().attr("value",e._id||e.name),t.schemaElement.enum.push(e._id||e.name);var o={id:e._id||e.name,text:e.name};s(o)}}}),n(t.el).removeClass("hidden")})}},imageselect:{template:'<div><input type="hidden" name="<%= node.name %>" id="<%= node.id %>" value="<%= value %>" /><div class="dropdown"><a class="btn<% if (buttonClass && node.value) { %> <%= buttonClass %><% } %>" data-toggle="dropdown" href="#"<% if (node.value) { %> style="max-width:<%= width %>px;max-height:<%= height %>px"<% } %>><% if (node.value) { %><img src="<% if (!node.value.match(/^https?:/)) { %><%= prefix %><% } %><%= node.value %><%= suffix %>" alt="" /><% } else { %><%= buttonTitle %><% } %></a><div class="dropdown-menu navbar" id="<%= node.id %>_dropdown"><div><% _.each(node.options, function(key, idx) { if ((idx > 0) && ((idx % columns) === 0)) { %></div><div><% } %><a class="btn<% if (buttonClass) { %> <%= buttonClass %><% } %>" style="max-width:<%= width %>px;max-height:<%= height %>px"><% if (key instanceof Object) { %><img src="<% if (!key.value.match(/^https?:/)) { %><%= prefix %><% } %><%= key.value %><%= suffix %>" alt="<%= key.title %>" /></a><% } else { %><img src="<% if (!key.match(/^https?:/)) { %><%= prefix %><% } %><%= key %><%= suffix %>" alt="" /><% } %></a> <% }); %></div><div class="pagination-right"><a class="btn">Reset</a></div></div></div></div>',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(e,t){var n=t.formElement||{},r=null,i=n.imageSelectorColumns||5;e.buttonTitle=n.imageSelectorTitle||"Select...",e.prefix=n.imagePrefix||"",e.suffix=n.imageSuffix||"",e.width=n.imageWidth||32,e.height=n.imageHeight||32,e.buttonClass=n.imageButtonClass||!1,t.options.length>i?(r=Math.ceil(t.options.length/i),e.columns=Math.ceil(t.options.length/r)):e.columns=i},getElement:function(e){return n(e).parent().get(0)},onInsert:function(e,t){n(t.el).on("click",".dropdown-menu a",function(e){e.preventDefault(),e.stopPropagation();var r=e.target.nodeName.toLowerCase()==="img"?n(e.target):n(e.target).find("img"),i=r.attr("src"),s=t.formElement||{},o=s.imagePrefix||"",u=s.imageSuffix||"",a=s.imageWidth||32,f=s.imageHeight||32;i?(i.indexOf(o)===0&&(i=i.substring(o.length)),i=i.substring(0,i.length-u.length),n(t.el).find("input").attr("value",i),n(t.el).find('a[data-toggle="dropdown"]').addClass(s.imageButtonClass).attr("style","max-width:"+a+"px;max-height:"+f+"px").html('<img src="'+(i.match(/^https?:/)?"":o)+i+u+'" alt="" />')):(n(t.el).find("input").attr("value",""),n(t.el).find('a[data-toggle="dropdown"]').removeClass(s.imageButtonClass).removeAttr("style").html(s.imageSelectorTitle||"Select..."))})}},radios:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><div class="radio"><label><input type="radio" <% if (((key instanceof Object) && (value === key.value)) || (value === key)) { %> checked="checked" <% } %> name="<%= node.name %>" value="<%= (key instanceof Object ? key.value : key) %>"<%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %>/><%= (key instanceof Object ? key.title : key) %></label></div><% }); %></div>',fieldtemplate:!0,inputfield:!0},radiobuttons:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><div class="radio"><label class="radio btn"><input type="radio" style="position:absolute;left:-9999px;" <% if (((key instanceof Object) && (value === key.value)) || (value === key)) { %> checked="checked" <% } %> name="<%= node.name %>" value="<%= (key instanceof Object ? key.value : key) %>" /><%= (key instanceof Object ? key.title : key) %></label></div><% }); %></div>',fieldtempate:!0,inputfield:!0,onInsert:function(e,t){var r="active",i=t.formElement||{};i.activeClass&&(r+=" "+i.activeClass),n(t.el).find("label").on("click",function(){n(this).parent().find("label").removeClass(r),n(this).addClass(r)})}},checkboxes:{template:'<div class="checkbox"><%= choiceshtml %></div>',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(e,t){var n=null,i=null,s='<label><input type="checkbox" <% if (value) { %> checked="checked" <% } %> name="<%= name %>" value="1"<%= (node.disabled? " disabled" : "")%>/> <%= title %></label>';if(!t||!t.schemaElement||!t.schemaElement.items)return;n=t.schemaElement.items["enum"]||t.schemaElement.items[0]["enum"];if(!n)return;i="",r.each(n,function(e,n){i+=r.template(s,{name:t.key+"["+n+"]",value:r.include(t.value,e),title:t.formElement.titleMap?t.formElement.titleMap[e]:e,node:t},o)}),e.choiceshtml=i}},array:{template:'<div id="<%= id %>"><input type="hidden" name="<%= node.name %>" value="[]" /><ul class="_jsonform-array-ul" style="list-style-type:none;"><%= children %></ul><span class="_jsonform-array-buttons"><a href="#" class="btn btn-default btn-xs _jsonform-array-addmore"><span class="fa fa-plus" title="Add new"></span></a> </span></div> <div class="col-sm-12 array-warning-message hidden"><div class="alert alert-warning"></div></div>',fieldtemplate:!0,array:!0,childTemplate:function(e){return n("").sortable?'<li data-idx="<%= node.childPos %>"><span class="draggable line"><i class="icon-list" title="Move item"></i></span>'+e+"</li>":'<li class=<% if (_.isUndefined(node.title) || node.type !== "object") { %> "col-sm-12" <% } else { %> "col-sm-offset-1 col-sm-11" <% } %>data-idx="<%= node.childPos %>"><a href="#" class="pull-right btn btn-default btn-xs _jsonform-array-deleteidx"><span class="fa fa-minus" title="Delete item"></span></a>'+e+"</li>"},onInsert:function(e,t){var i=n(t.el).find("#"+p(t.id)),s=t.getArrayBoundaries();t.resetDeleteEvents();var o=t.title+" "+gettext("contains items that are outside your scope, please consult a global administrator if you need more information.");n(t.el).find(".alert-warning").html(o);var u=function(e,r){if(e===r)return;var s=e<r?1:-1,o=0,u=n("> ul",i);for(o=e;o!==r;o+=s)t.children[o].switchValuesWith(t.children[o+s]),t.children[o].render(u.get(0)),t.children[o+s].render(u.get(0));var a=n(t.children[e].el),f=n(t.children[r].el);a.detach(),f.detach(),e<r?(e===0?u.prepend(a):n(t.children[e-1].el).after(a),n(t.children[r-1].el).after(f)):(r===0?u.prepend(f):n(t.children[r-1].el).after(f),n(t.children[e-1].el).after(a))};n("> span > a._jsonform-array-addmore",i).click(function(e){e.preventDefault(),e.stopPropagation();var r=t.children.length;if(s.maxItems>=0){t.children.length>s.maxItems-2&&i.find("> span > a._jsonform-array-addmore").addClass("disabled");if(t.children.length>s.maxItems-1)return!1}t.insertArrayItem(r,n("> ul",i).get(0)),(s.minItems<=0||s.minItems>0&&t.children.length>s.minItems-1)&&i.find("> span > a._jsonform-array-deletelast").removeClass("disabled")});var a=n("> ul > li",i).length;if(s.minItems>0&&a<s.minItems)for(var f=0;f<s.minItems-1&&i.find("> ul > li").length<s.minItems;f++)t.insertArrayItem(a,i.find("> ul").get(0));s.minItems>0&&t.children.length<=s.minItems&&i.find("> span > a._jsonform-array-deletelast").addClass("disabled"),n("> span > a._jsonform-array-deletelast",i).click(function(e){var n=t.children.length-1;e.preventDefault(),e.stopPropagation();if(s.minItems>0){t.children.length<s.minItems+2&&i.find("> span > a._jsonform-array-deletelast").addClass("disabled");if(t.children.length<=s.minItems)return!1}else t.children.length===1&&i.find("> span > a._jsonform-array-deletelast").addClass("disabled");t.deleteArrayItem(n),s.maxItems>=0&&n<=s.maxItems-1&&i.find("> span > a._jsonform-array-addmore").removeClass("disabled")}),n(t.el).sortable&&(n("> ul",i).sortable(),n("> ul",i).bind("sortstop",function(e,t){var r=n(t.item).data("idx"),i=n(t.item).index();u(r,i)})),r.each(n(t.el).find("li"),function(e){n(e).find(".collapse").first().removeClass("collapse")})}},tabarray:{template:'<div id="<%= id %>"><div class="tabbable tabs-left"><ul class="nav nav-tabs"><%= tabs %></ul><div class="tab-content"><%= children %></div></div><a href="#" class="btn btn-default btn-xs _jsonform-array-addmore"><span class="fa fa-plus" title="Add new"></span></a> <a href="#" class="btn btn-default btn-xs _jsonform-array-deleteitem"><span class="fa fa-minus" title="Delete item"></span></a></div>',fieldtemplate:!0,array:!0,childTemplate:function(e){return'<div data-idx="<%= node.childPos %>" id="<%= node.childPos %>" class="tab-pane">'+e+"</div>"},onBeforeRender:function(e,t){var n="";r.each(t.children,function(e,t){var r=e.legend||e.title||"Item "+(t+1);n+='<li data-idx="'+t+'"'+(t===0?' class="active"':"")+'><a href="#'+t+'" class="draggable tab" data-toggle="tab">'+h(r)+"</a></li>"}),e.tabs=n},onInsert:function(e,t){var i=n(t.el).find("#"+p(t.id)),s=t.getArrayBoundaries(),o=function(e,r){if(e===r)return;var s=e<r?1:-1,o=0,u=n("> .tabbable > .tab-content",i).get(0);for(o=e;o!==r;o+=s)t.children[o].switchValuesWith(t.children[o+s]),t.children[o].render(u),t.children[o+s].render(u)},u=function(e){var s="",o=!1;e===undefined&&(e=n("> .tabbable > .nav-tabs .active",i).data("idx"),e?e=parseInt(e,10):(o=!0,e=0)),e>=t.children.length&&(e=t.children.length-1),r.each(t.children,function(e,t){var n=e.legend||e.title||"Item "+(t+1);s+='<li data-idx="'+t+'">'+'<a href="#'+t+'" class="draggable tab" data-toggle="tab">'+h(n)+"</a></li>"}),n("> .tabbable > .nav-tabs",i).html(s),o&&n('> .tabbable > .nav-tabs [data-idx="0"]',i).addClass("active"),n('> .tabbable > .nav-tabs [data-toggle="tab"]',i).eq(e).click()};n("> a._jsonform-array-deleteitem",i).click(function(e){var r=n("> .tabbable > .nav-tabs .active",i).data("idx");e.preventDefault(),e.stopPropagation();if(s.minItems>0){t.children.length<s.minItems+1&&i.find("> a._jsonform-array-deleteitem").addClass("disabled");if(t.children.length<=s.minItems)return!1}t.deleteArrayItem(r),u(),(t.children.length<s.minItems+1||t.children.length===0)&&i.find("> a._jsonform-array-deleteitem").addClass("disabled"),s.maxItems>=0&&t.children.length<=s.maxItems&&i.find("> a._jsonform-array-addmore").removeClass("disabled")}),n("> a._jsonform-array-addmore",i).click(function(e){var r=t.children.length;if(s.maxItems>=0){t.children.length>s.maxItems-2&&n("> a._jsonform-array-addmore",i).addClass("disabled");if(t.children.length>s.maxItems-1)return!1}e.preventDefault(),e.stopPropagation(),t.insertArrayItem(r,i.find("> .tabbable > .tab-content").get(0)),u(r),(s.minItems<=0||s.minItems>0&&r>s.minItems-1)&&i.find("> a._jsonform-array-deleteitem").removeClass("disabled")}),n(t.el).on("legendUpdated",function(e){u(),e.preventDefault(),e.stopPropagation()}),n(t.el).sortable&&(n("> .tabbable > .nav-tabs",i).sortable({containment:t.el,tolerance:"pointer"}),n("> .tabbable > .nav-tabs",i).bind("sortstop",function(e,t){var r=n(t.item).data("idx"),i=n(t.item).index();o(r,i),u(i)}));if(s.minItems>=0){for(var a=0;a<s.minItems-1;a++)i.find("> a._jsonform-array-addmore").click();i.find("> a._jsonform-array-deleteitem").addClass("disabled"),u()}s.maxItems>=0&&t.children.length>=s.maxItems&&i.find("> a._jsonform-array-addmore").addClass("disabled"),s.minItems>=0&&t.children.length<=s.minItems&&i.find("> a._jsonform-array-deleteitem").addClass("disabled")}},help:{template:'<span class="help-block" style="padding-top:5px"><%= elt.helpvalue %></span>',fieldtemplate:!0},msg:{template:"<%= elt.msg %>"},fieldset:{template:'<fieldset class="jsonform-error-<%= keydash %> <% if (elt.expandable) { %>expandable<% } %> <%= elt.htmlClass?elt.htmlClass:"" %>" <% if (id) { %> id="<%= id %>"<% } %>><% if (node.title || node.legend) { %><legend><span id="caret" class="fa fa-caret-right"></span> <%= node.getLocalizedAttr("title") || node.legend %></legend><% } %><div <% if (node.title || node.legend) { %> class="collapse" <% } %>><%= children %></div></fieldset>'},advancedfieldset:{template:'<fieldset<% if (id) { %> id="<%= id %>"<% } %> class="expandable <%= elt.htmlClass?elt.htmlClass:"" %>"><legend>Advanced options</legend><div><%= children %></div></fieldset>'},authfieldset:{template:'<fieldset<% if (id) { %> id="<%= id %>"<% } %> class="expandable <%= elt.htmlClass?elt.htmlClass:"" %>"><legend>Authentication settings</legend><div><%= children %></div></fieldset>'},submit:{template:'<input type="submit" <% if (id) { %> id="<%= id %>" <% } %> class="btn btn-primary <%= elt.htmlClass?elt.htmlClass:"" %>" value="<%= value || node.title %>"<%= (node.disabled? " disabled" : "")%>/>'},button:{template:' <button <% if (id) { %> id="<%= id %>" <% } %> class="btn <%= elt.htmlClass?elt.htmlClass:"btn-default" %>"><%= node.getLocalizedAttr("title") %></button> '},actions:{template:'<div class="<%= elt.htmlClass?elt.htmlClass:"" %>"><%= children %></div>'},hidden:{template:'<input type="hidden" id="<%= id %>" name="<%= node.name %>" value="<%= escape(value) %>" />',inputfield:!0},selectfieldset:{template:'<fieldset class="tab-container <%= elt.htmlClass?elt.htmlClass:"" %>"><% if (node.legend) { %><legend><%= node.legend %></legend><% } %><% if (node.formElement.key) { %><input type="hidden" id="<%= node.id %>" name="<%= node.name %>" value="<%= escape(value) %>" /><% } else { %><a id="<%= node.id %>"></a><% } %><div class="tabbable"><div class="control-group<%= node.formElement.hideMenu ? " hide" : "" %>"><% if (node.title && !elt.notitle) { %><label class="control-label" for="<%= node.id %>"><%= node.getLocalizedAttr("title") %></label><% } %><div class="controls"><%= tabs %></div></div><div class="tab-content"><%= children %></div></div></fieldset>',inputfield:!0,getElement:function(e){return n(e).parent().get(0)},childTemplate:function(e){return'<div data-idx="<%= node.childPos %>" class="tab-pane<% if (node.active) { %> active<% } %>">'+e+"</div>"},onBeforeRender:function(e,t){var n=null,i=[];t.schemaElement&&(i=t.schemaElement["enum"]||[]),t.options?n=r.map(t.options,function(e,n){var s=t.children[n];return e instanceof Object?(e=r.extend({node:s},e),e.title=e.title||s.legend||s.title||"Option "+(s.childPos+1),e.value=a(e.value)?e.value:a(i[n])?i[n]:n,e):{title:e,value:a(i[s.childPos])?i[s.childPos]:s.childPos,node:s}}):n=r.map(t.children,function(e,t){return{title:e.legend||e.title||"Option "+(e.childPos+1),value:i[e.childPos]||e.childPos,node:e}});var s=null;e.value&&(s=r.find(n,function(e){return e.value===t.value})),s||(s=r.find(n,function(e){return e.node.hasNonDefaultValue()})),s||(s=n[0]),s.node.active=!0,e.value=s.value;var o=t.formElement,u='<select class="nav"'+(t.disabled?" disabled":"")+">";return r.each(n,function(e,t){u+='<option data-idx="'+t+'" value="'+e.value+'"'+(e.node.active?' class="active"':"")+">"+h(e.title)+"</option>"}),u+="</select>",e.tabs=u,e},onInsert:function(e,t){n(t.el).find("select.nav").first().on("change",function(e){var r=n(this).find("option:selected");n(t.el).find('input[type="hidden"]').first().val(r.attr("value"))})}},optionfieldset:{template:'<div<% if (node.id) { %> id="<%= node.id %>"<% } %>><%= children %></div>'},section:{template:'<div<% if (node.id) { %> id="<%= node.id %>"<% } %>><%= children %></div>'},questions:{template:'<div><input type="hidden" id="<%= node.id %>" name="<%= node.name %>" value="<%= escape(value) %>" /><%= children %></div>',fieldtempate:!0,inputfield:!0,getElement:function(e){return n(e).parent().get(0)},onInsert:function(e,t){if(!t.children||t.children.length===0)return;r.each(t.children,function(e){n(e.el).hide()}),n(t.children[0].el).show()}},question:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><div class="radio"><label class="<%= ((key instanceof Object && key.htmlClass) ? " " + key.htmlClass : "") %>"><input type="radio" <% if (node.formElement.optionsType === "radiobuttons") { %> style="position:absolute;left:-9999px;" <% } %>name="<%= node.id %>" value="<%= val %>"<%= (node.disabled? " disabled" : "")%>/><%= (key instanceof Object ? key.title : key) %></label></div><% }); %></div>',fieldtemplate:!0,onInsert:function(e,t){var i="active",s=t.formElement||{};s.activeClass&&(i+=" "+s.activeClass),n(t.el).find('input[type="radio"]').on("change",function(e){var s=null,o=t.options[n(this).val()];if(!t.parentNode||!t.parentNode.el)return;n(this).parent().parent().find("label").removeClass(i),n(this).parent().addClass(i),n(t.el).nextAll().hide(),n(t.el).nextAll().find('input[type="radio"]').prop("checked",!1),o.value&&n(t.parentNode.el).find('input[type="hidden"]').val(o.value),o.next&&(s=r.find(t.parentNode.children,function(e){return e.formElement&&e.formElement.qid===o.next}),n(s.el).show(),n(s.el).nextAll().hide(),n(s.el).nextAll().find('input[type="radio"]').prop("checked",!1)),o.href&&(o.target?window.open(o.href,o.target):window.location=o.href),o.submit&&setTimeout(function(){t.ownerTree.submit()},0)})}}},f.util.getObjKey=function(e,t,n){var i=e,o=t.split("."),u=null,a=null,f=null;for(var l=0;l<o.length;l++){if(i===null||typeof i!="object")return null;u=o[l],f=u.replace(s,""),s.lastIndex=0,a=s.exec(u);if(a)for(;;){if(!r.isArray(i[f]))return null;i=i[f][parseInt(a[1],10)],a=s.exec(u);if(!a)break}else n&&!i[f]&&r.isArray(i)&&i[0]?i=i[0][f]:i=i[f]}return n&&r.isArray(i)&&i[0]?i[0]:i},f.util.setObjKey=function(e,t,n){var i=e,o=t.split("."),u=null,a=null,f=null;for(var l=0;l<o.length-1;l++){u=o[l],f=u.replace(s,""),s.lastIndex=0,a=s.exec(u)
;if(a){for(;;){r.isArray(i[f])||(i[f]=[]),i=i[f],f=parseInt(a[1],10),a=s.exec(u);if(!a)break}if(typeof i[f]!="object"||i[f]===null)i[f]={};i=i[f]}else{if(typeof i[f]!="object"||i[f]===null)i[f]={};i=i[f]}}u=o[o.length-1],f=u.replace(s,""),s.lastIndex=0,a=s.exec(u);if(a){for(;;){r.isArray(i[f])||(i[f]=[]),i=i[f],f=parseInt(a[1],10),a=s.exec(u);if(!a)break}i[f]=n}else i[f]=n};var g=function(e,t){var n=t.replace(/\./g,".properties.").replace(/\[[0-9]*\]/g,".items"),r=f.util.getObjKey(e,n,!0);if(r&&r.$ref)throw new Error("JSONForm does not yet support schemas that use the $ref keyword. See: https://github.com/joshfire/jsonform/issues/54");return r},y=function(e,t){var n=0,r=0;if(!e)return null;if(t>0)while(n<t){r=e.indexOf("[]",r);if(r===-1)return e;r+=2,n+=1}return r=e.indexOf("[]",r),r===-1?e:e.substring(0,r)},b=function(e,t){var n=0;if(!e)return null;if(!t||t.length===0)return e;var r=e.replace(s,function(e,r){var i=e;return a(t[n])&&(i="["+t[n]+"]"),n+=1,i});return r},w=function(e,t,n,i,s){var o=null;i=i||{},i.idx=i.idx||(n?n[n.length-1]:1),i.value=a(i.value)?i.value:"",i.getValue=i.getValue||function(t){return w(e,t,n,i,s)};var l=function(e,t){var n=null;return!e||!e.length?null:(r.each(e,function(e){if(n)return;if(e===t){n={key:e};return}if(r.isString(e))return;e.key===t?n=e:e.items&&(n=l(e.items,t))}),n)},c=l(e.form||[],t),h=g(e.schema.properties,t);return s&&e.value&&(o=f.util.getObjKey(e.value,b(t,n))),a(o)||(c&&typeof c.value!="undefined"?o=c.value:h&&a(h["default"])&&(o=h["default"]),o&&o.indexOf("{{values.")!==-1&&(o=o.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}')),o&&(o=r.template(o,i,u))),a(o)&&c&&c.titleMap&&c.titleMap[o]&&(o=r.template(c.titleMap[o],i,u)),o&&r.isString(o)&&h&&h.maxLength&&o.length>h.maxLength&&(o=o.substr(0,h.maxLength-1)+"â€¦"),a(o)?o:null},E=function(){this.id=null,this.key=null,this.el=null,this.formElement=null,this.schemaElement=null,this.view=null,this.children=[],this.ownerTree=null,this.parentNode=null,this.childTemplate=null,this.legendChild=null,this.arrayPath=[],this.childPos=0,this.lan=(window.navigator.language||navigator.browserLanguage).slice(0,2)};E.prototype.clone=function(e){var t=new E;return t.arrayPath=r.clone(this.arrayPath),t.ownerTree=this.ownerTree,t.parentNode=e||this.parentNode,t.formElement=this.formElement,t.schemaElement=this.schemaElement,t.view=this.view,t.children=r.map(this.children,function(e){return e.clone(t)}),this.childTemplate&&(t.childTemplate=this.childTemplate.clone(t)),t},E.prototype.hasNonDefaultValue=function(){if(this.formElement&&this.formElement.type=="hidden")return!1;if(this.value&&!this.defaultValue)return!0;var e=r.find(this.children,function(e){return e.hasNonDefaultValue()});return!!e},E.prototype.appendChild=function(e){return e.parentNode=this,e.childPos=this.children.length,this.children.push(e),e},E.prototype.removeChild=function(){var e=this.children[this.children.length-1];if(!e)return;return n(e.el).remove(),this.children.pop()},E.prototype.moveValuesTo=function(e){var t=this.getFormValues(e.arrayPath);e.resetValues(),e.computeInitialValues(t,!0)},E.prototype.switchValuesWith=function(e){var t=this.getFormValues(e.arrayPath),n=e.getFormValues(this.arrayPath);e.resetValues(),e.computeInitialValues(t,!0),this.resetValues(),this.computeInitialValues(n,!0)},E.prototype.resetValues=function(){var e=null,t=0;this.value=null,this.parentNode?(this.arrayPath=r.clone(this.parentNode.arrayPath),this.parentNode.view&&this.parentNode.view.array&&this.arrayPath.push(this.childPos)):this.arrayPath=[];if(this.view&&this.view.inputfield)e=n(":input",this.el).serializeArray(),r.each(e,function(e){n('[name="'+p(e.name)+'"]',n(this.el)).val("")},this);else if(this.view&&this.view.array)while(this.children.length>0)this.removeChild();r.each(this.children,function(e){e.resetValues()})},E.prototype.setChildTemplate=function(e){this.childTemplate=e,e.parentNode=this},E.prototype.computeInitialValues=function(e,t){var n=this,i=null,s=1,o=0,l=this.ownerTree.formDesc.tpldata||{};this.parentNode?(this.arrayPath=r.clone(this.parentNode.arrayPath),this.parentNode.view&&this.parentNode.view.array&&this.arrayPath.push(this.childPos)):this.arrayPath=[],l.idx=this.arrayPath.length>0?this.arrayPath[this.arrayPath.length-1]+1:this.childPos+1,l.value="",l.getValue=function(t){return w(n.ownerTree.formDesc,t,n.arrayPath,l,!!e)};if(this.formElement){if(this.formElement.id)this.id=b(this.formElement.id,this.arrayPath);else if(this.view&&this.view.array)this.id=p(this.ownerTree.formDesc.prefix)+"-elt-counter-"+r.uniqueId();else if(this.parentNode&&this.parentNode.view&&this.parentNode.view.array)this.id=p(this.ownerTree.formDesc.prefix)+"-elt-counter-"+r.uniqueId();else if(this.formElement.type==="button"||this.formElement.type==="selectfieldset"||this.formElement.type==="question"||this.formElement.type==="buttonquestion")this.id=p(this.ownerTree.formDesc.prefix)+"-elt-counter-"+r.uniqueId();this.formElement.key&&(this.key=b(this.formElement.key,this.arrayPath),this.keydash=this.key.replace(/\./g,"---")),this.name=b(this.formElement.name,this.arrayPath),r.each(["title","legend","description","append","prepend","inlinetitle","helpvalue","value","disabled","placeholder","readOnly"],function(e){r.isString(this.formElement[e])?(this.formElement[e].indexOf("{{values.")!==-1?this[e]=this.formElement[e].replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):this[e]=b(this.formElement[e],this.arrayPath),this[e]&&(this[e]=r.template(this[e],l,u))):this[e]=this.formElement[e]},this),this.formElement.options&&(this.options=r.map(this.formElement.options,function(e){var t=null;return r.isObject(e)&&e.title?(e.title.indexOf("{{values.")!==-1?t=e.title.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):t=b(e.title,n.arrayPath),r.extend({},e,{value:a(e.value)?e.value:"",title:r.template(t,l,u)})):e}))}if(this.view&&this.view.inputfield&&this.schemaElement)e?a(f.util.getObjKey(e,this.key))&&(this.value=f.util.getObjKey(e,this.key)):t||!a(this.value)&&a(this.schemaElement["default"])&&(this.value=this.schemaElement["default"],r.isString(this.value)&&(this.value.indexOf("{{values.")!==-1?this.value=this.value.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):this.value=b(this.value,this.arrayPath),this.value&&(this.value=r.template(this.value,l,u))),this.defaultValue=!0);else if(this.view&&this.view.array){s=0,e?s=this.getPreviousNumberOfItems(e,this.arrayPath):s===0&&(s=1);for(o=0;o<s;o++)this.appendChild(this.childTemplate.clone())}r.each(this.children,function(n){n.computeInitialValues(e,t)});if(this.formElement&&this.formElement.valueInLegend){i=this;while(i){if(i.parentNode&&i.parentNode.view&&i.parentNode.view.array){i.legendChild=this;if(i.formElement&&i.formElement.legend){i.legend=b(i.formElement.legend,i.arrayPath),l.idx=i.arrayPath.length>0?i.arrayPath[i.arrayPath.length-1]+1:i.childPos+1,l.value=a(this.value)?this.value:"",i.legend=r.template(i.legend,l,u);break}}i=i.parentNode}}},E.prototype.getPreviousNumberOfItems=function(e,t){var n=null,i=null,s=null,o=0;return e?this.view.inputfield&&this.schemaElement?(n=y(this.formElement.key,t.length),n=b(n,t),i=f.util.getObjKey(e,n),i?(s=r.map(this.children,function(n){return n.getPreviousNumberOfItems(e,t)}),r.max([r.max(s)||0,i.length])):0):this.view.array?this.childTemplate.getPreviousNumberOfItems(e,t):(s=r.map(this.children,function(n){return n.getPreviousNumberOfItems(e,t)}),r.max(s)||0):0},E.prototype.getFormValues=function(e){var t={};if(!this.el)throw new Error("formNode.getFormValues can only be called on nodes that are associated with a DOM element in the tree");var s=n(":input",this.el).serializeArray();s=s.concat(n(":input[type=checkbox]:not(:disabled):not(:checked)",this.el).map(function(){return{name:this.name,value:this.checked}}).get()),e&&r.each(s,function(t){t.name=b(t.name,e)});var o=this.ownerTree.formDesc.schema;for(var u=0;u<s.length;u++){var a=s[u].name,l=g(o.properties,a),c=null,h=null;if(!l)continue;if(l._jsonform_checkboxes_as_array){c=a.match(/\[([0-9]*)\]$/);if(c){a=a.replace(/\[([0-9]*)\]$/,""),h=f.util.getObjKey(t,a)||[],s[u].value==="1"&&h.push(l["enum"][parseInt(c[1],10)]),f.util.setObjKey(t,a,h);continue}}l.type==="boolean"&&(s[u].value==="0"?s[u].value=!1:s[u].value=!!s[u].value),(l.type==="number"||l.type==="integer")&&r.isString(s[u].value)&&(s[u].value.length?isNaN(Number(s[u].value))||(s[u].value=Number(s[u].value)):s[u].value=null),l.type==="string"&&s[u].value===""&&!l._jsonform_allowEmpty&&(s[u].value=null);if(l.type==="object"&&r.isString(s[u].value)&&s[u].value.substring(0,1)==="{")try{s[u].value=i.parse(s[u].value)}catch(p){s[u].value={}}if(l.type==="array"&&s[u].value==="[]"&&r.isUndefined(t[s[u].name])){f.util.setObjKey(t,s[u].name,[]);continue}l.type==="object"&&(s[u].value==="null"||s[u].value==="")&&(s[u].value=null),s[u].name&&s[u].value!==null&&f.util.setObjKey(t,s[u].name,s[u].value)}return t},E.prototype.render=function(e){var t=this.generate();this.setContent(t,e),this.enhance()},E.prototype.getLocalizedAttr=function(e,t){return t=t||this.lan,this.schemaElement[e+"_"+t]||this[e]},E.prototype.setContent=function(e,t){var r=n(e),i=t||(this.parentNode?this.parentNode.el:this.ownerTree.domRoot),s=null;this.el?n(this.el).replaceWith(r):(s=n(i).children().get(this.childPos),s?n(s).before(r):n(i).append(r)),this.el=r,this.updateElement(this.el)},E.prototype.updateElement=function(e){if(this.id){this.el=n("#"+p(this.id),e).get(0),this.view&&this.view.getElement&&(this.el=this.view.getElement(this.el));if(this.fieldtemplate!==!1&&this.view&&this.view.fieldtemplate){this.el=n(this.el).parent().parent();if(this.prepend||this.prepend)this.el=this.el.parent();this.el=this.el.get(0)}this.parentNode&&this.parentNode.view&&this.parentNode.view.childTemplate&&(this.el=n(this.el).parent().get(0))}r.each(this.children,function(t){t.updateElement(this.el||e)})},E.prototype.generate=function(){var e={id:this.id,keydash:this.keydash,elt:this.formElement,schema:this.schemaElement,node:this,value:a(this.value)?this.value:"",escape:h},t=null,n="";this.ownerTree.formDesc.onBeforeRender&&this.ownerTree.formDesc.onBeforeRender(e,this),this.view.onBeforeRender&&this.view.onBeforeRender(e,this),this.template?t=this.template:this.formElement&&this.formElement.template?t=this.formElement.template:t=this.view.template,this.fieldtemplate!==!1&&(this.fieldtemplate||this.view.fieldtemplate)&&(t=f.fieldTemplate(t)),this.parentNode&&this.parentNode.view&&this.parentNode.view.childTemplate&&(t=this.parentNode.view.childTemplate(t));var i="";return r.each(this.children,function(e){i+=e.generate()}),e.children=i,e.fieldHtmlClass="",this.ownerTree&&this.ownerTree.formDesc&&this.ownerTree.formDesc.params&&this.ownerTree.formDesc.params.fieldHtmlClass&&(e.fieldHtmlClass=this.ownerTree.formDesc.params.fieldHtmlClass),this.formElement&&typeof this.formElement.fieldHtmlClass!="undefined"&&(e.fieldHtmlClass=this.formElement.fieldHtmlClass),n=r.template(t,e,o),n},E.prototype.enhance=function(){var e=this,t=null,i=null,s=r.clone(this.ownerTree.formDesc.tpldata)||{};this.formElement&&(this.view.onInsert&&this.view.onInsert({target:n(this.el)},this),t=this.handlers||this.formElement.handlers,i=this.onInsert||this.formElement.onInsert,i&&i({target:n(this.el)},this),t&&r.each(t,function(e,t){t==="insert"&&e({target:n(this.el)},this)},this),this.el&&(this.onChange&&n(this.el).bind("change",function(t){e.onChange(t,e)}),this.view.onChange&&n(this.el).bind("change",function(t){e.view.onChange(t,e)}),this.formElement.onChange&&n(this.el).bind("change",function(t){e.formElement.onChange(t,e)}),this.onClick&&n(this.el).bind("click",function(t){e.onClick(t,e)}),this.view.onClick&&n(this.el).bind("click",function(t){e.view.onClick(t,e)}),this.formElement.onClick&&n(this.el).bind("click",function(t){e.formElement.onClick(t,e)}),this.onKeyUp&&n(this.el).bind("keyup",function(t){e.onKeyUp(t,e)}),this.view.onKeyUp&&n(this.el).bind("keyup",function(t){e.view.onKeyUp(t,e)}),this.formElement.onKeyUp&&n(this.el).bind("keyup",function(t){e.formElement.onKeyUp(t,e)}),t&&r.each(t,function(t,r){r!=="insert"&&n(this.el).bind(r,function(n){t(n,e)})},this)),this.legendChild&&this.legendChild.formElement&&n(this.legendChild.el).bind("keyup",function(t){e.formElement&&e.formElement.legend&&e.parentNode&&(e.legend=b(e.formElement.legend,e.arrayPath),s.idx=e.arrayPath.length>0?e.arrayPath[e.arrayPath.length-1]+1:e.childPos+1,s.value=n(t.target).val(),e.legend=r.template(e.legend,s,u),n(e.parentNode.el).trigger("legendUpdated"))})),n(this.el).find("legend").off().click(function(e){e.preventDefault(),e.stopPropagation();var t=n(e.target).hasClass("fa")?n(e.target).parent():n(e.target),r=t.find("#caret"),i=r.hasClass("fa-caret-down")?"fa-caret-right":"fa-caret-down";r.removeClass().addClass("fa "+i),t.parent().children("div").slideToggle()}),n(this.el).children(".collapse").hide(),r.each(this.children,function(e){e.enhance()})},E.prototype.resetDeleteEvents=function(){var e=this;n(this.el).find("a._jsonform-array-deleteidx").off().click(function(t){var r=n(t.target).parent().attr("data-idx")||n(t.target).parent().parent().attr("data-idx"),i=e.getArrayBoundaries();r=Number.parseInt(r),t.preventDefault(),t.stopPropagation();if(i.minItems>0){e.children.length<i.minItems+2&&n(e.el).find("> span > a._jsonform-array-deletelast").addClass("disabled");if(e.children.length<=i.minItems)return!1}else e.children.length===1&&n(e.el).find("> span > a._jsonform-array-deletelast").addClass("disabled");e.deleteArrayItem(r),i.maxItems>=0&&r<=i.maxItems-1&&n(e.el).find("> span > a._jsonform-array-addmore").removeClass("disabled")})},E.prototype.insertArrayItem=function(e,t){var r=0;e===undefined&&(e=this.children.length);var i=this.childTemplate.clone();this.appendChild(i),i.resetValues();for(r=this.children.length-2;r>=e;r--)this.children[r].moveValuesTo(this.children[r+1]);this.children[e].resetValues(),this.children[e].computeInitialValues();for(r=e;r<this.children.length;r++)this.children[r].render(t);this.resetDeleteEvents(),n(i.el).find(".collapse").first().removeClass("collapse")},E.prototype.deleteArrayItem=function(e){var t=0,r=null;e===undefined&&(e=this.children.length-1);for(t=e;t<this.children.length-1;t++)this.children[t+1].moveValuesTo(this.children[t]),this.children[t].render(),n(this.children[t].el).find(".collapse").first().removeClass("collapse");this.removeChild(),this.resetDeleteEvents()},E.prototype.getArrayBoundaries=function(){var e={minItems:-1,maxItems:-1};if(!this.view||!this.view.array)return e;var t=function(e,n){var i=null,s=null,o={minItems:-1,maxItems:-1};return n=n||e,e.view&&e.view.array&&e!==n?o:e.key?(s=e.key.replace(/\[[0-9]+\]/g,"[]"),e!==n&&(s=s.replace(/\[\][^\[\]]*$/,"")),i=g(e.ownerTree.formDesc.schema.properties,s),i?{minItems:i.minItems||i.minLength||-1,maxItems:i.maxItems||i.maxLength||-1}:o):(r.each(e.children,function(e){var r=t(e,n);r.minItems!==-1&&(o.minItems!==-1?o.minItems=Math.max(o.minItems,r.minItems):o.minItems=r.minItems),r.maxItems!==-1&&(o.maxItems!==-1?o.maxItems=Math.min(o.maxItems,r.maxItems):o.maxItems=r.maxItems)}),o)};return t(this)};var S=function(){this.eventhandlers=[],this.root=null,this.formDesc=null};S.prototype.initialize=function(e){e=e||{},this.formDesc=r.clone(e),this.formDesc.prefix=this.formDesc.prefix||"jsonform-"+r.uniqueId(),this.formDesc.schema&&!this.formDesc.schema.properties&&(this.formDesc.schema={properties:this.formDesc.schema}),this.formDesc.form=this.formDesc.form||["*",{type:"actions",items:[{type:"submit",value:"Submit"}]}],this.formDesc.form=r.isArray(this.formDesc.form)?this.formDesc.form:[this.formDesc.form],this.formDesc.params=this.formDesc.params||{},this.root=new E,this.root.ownerTree=this,this.root.view=f.elementTypes.root,this.buildTree(),this.computeInitialValues()},S.prototype.buildTree=function(){r.each(this.formDesc.form,function(e){if(e==="*"){var t=r.clone(this.formDesc.schema.properties),n={};this.formDesc.schema.order&&r.each(this.formDesc.schema.order,function(e){this.root.appendChild(this.buildFromLayout({key:e})),delete t[e]},this),r.each(t,function(e,t){if(!r.isUndefined(e.properties)){n[t]=e;return}this.root.appendChild(this.buildFromLayout({key:t}))},this),r.each(n,function(e,t){this.root.appendChild(this.buildFromLayout({key:t}))},this)}else r.isString(e)&&(e={key:e}),this.root.appendChild(this.buildFromLayout(e))},this)},S.prototype.buildFromLayout=function(e,t){var n=null,i=new E,s=null,o=null;e=r.clone(e),e.items&&(r.isArray(e.items)?e.items=r.map(e.items,r.clone):e.items=[r.clone(e.items)]);if(e.key){n=g(this.formDesc.schema.properties,e.key);if(!n)throw new Error('The JSONForm object references the schema key "'+e.key+'" but that key does not exist in the JSON schema');this.formDesc.onElementSchema&&this.formDesc.onElementSchema(e,n),e.name=e.name||e.key,e.title=e.title||n.title,e.inlinetitle=e.inlinetitle||n.inlinetitle,e.description=e.description||n.description,e.readOnly=e.readOnly||n.readOnly||e.readonly||n.readonly,e.id||(e.id=p(this.formDesc.prefix)+"-elt-"+e.key),e.allowEmpty&&(n._jsonform_allowEmpty=!0),e.type||(n.type==="string"&&n.format==="color"?e.type="color":n.type!=="number"&&n.type!=="integer"&&n.type!=="string"&&n.type!=="any"||!!n["enum"]?n.type==="boolean"?e.type="checkbox":n.type==="object"?n.properties?e.type="fieldset":e.type="textarea":r.isUndefined(n["enum"])?e.type=n.type:e.type="select":e.type="text"),!e.options&&n["enum"]&&(e.titleMap?e.options=r.map(n["enum"],function(t){return{value:t,title:e.titleMap[t]||t}}):e.options=n["enum"]);if(e.type==="checkboxes"&&n.items){var u=n.items["enum"];u&&(n.items._jsonform_checkboxes_as_array=!0),!u&&n.items[0]&&(u=n.items[0]["enum"],u&&(n.items[0]._jsonform_checkboxes_as_array=!0))}if(n.type==="object"){var a=r.clone(n.properties),l={};n.order&&r.each(n.order,function(t){i.appendChild(this.buildFromLayout({key:e.key+"."+t})),delete a[t]},this),r.each(a,function(t,n){if(t.type==="object"){l[n]=t;return}i.appendChild(this.buildFromLayout({key:e.key+"."+n}))},this),r.each(l,function(t,n){i.appendChild(this.buildFromLayout({key:e.key+"."+n}))},this)}}e.type||(e.type="none"),s=f.elementTypes[e.type];if(!s)throw new Error('The JSONForm contains an element whose type is unknown: "'+e.type+'"');if(n){if(!s.inputfield&&!s.array&&e.type!=="selectfieldset"&&n.type!=="object")throw new Error('The JSONForm contains an element that links to an element in the JSON schema (key: "'+e.key+'") '+'and that should not based on its type ("'+e.type+'")')}else if(s.inputfield&&e.type!=="selectfieldset")throw new Error('The JSONForm defines an element of type "'+e.type+'" '+'but no "key" property to link the input field to the JSON schema');return e.iddot=p(e.id||""),i.formElement=e,i.schemaElement=n,i.view=s,i.ownerTree=this,e.handlers||(e.handlers={}),i.view.array?(e.items?o=e.items[0]||e.items:o=e.key+"[]",r.isString(o)&&(o={key:o}),i.setChildTemplate(this.buildFromLayout(o))):e.items&&r.each(e.items,function(e){r.isString(e)&&(e={key:e}),i.appendChild(this.buildFromLayout(e))},this),i},S.prototype.computeInitialValues=function(){this.root.computeInitialValues(this.formDesc.value)},S.prototype.render=function(e){if(!e)return;this.domRoot=e,this.root.render(),this.hasRequiredField()&&n(e).addClass("jsonform-hasrequired")},S.prototype.forEachElement=function(e){var t=function(n){for(var r=0;r<n.children.length;r++)e(n.children[r]),t(n.children[r])};t(this.root)},S.prototype.validate=function(e){var r=f.getFormValue(this.domRoot),i=!1,s=this.formDesc;if(s.validate!==!1){var o=!1;typeof s.validate!="object"?t.JSONFormValidator&&(o=t.JSONFormValidator.createEnvironment("json-schema-draft-03")):o=s.validate;if(o){var u=o.validate(r,this.formDesc.schema);n(this.domRoot).jsonFormErrors(!1,s),u.errors.length&&(i||(i=[]),i=i.concat(u.errors))}}return i&&!e&&(s.displayErrors?s.displayErrors(i,this.domRoot):n(this.domRoot).jsonFormErrors(i,s)),{errors:i}},S.prototype.submit=function(e){var t=function(){return e&&(e.preventDefault(),e.stopPropagation()),!1},n=f.getFormValue(this.domRoot),r=this.formDesc,i=!1;this.forEachElement(function(t){if(i)return;t.view.onSubmit&&(i=!t.view.onSubmit(e,t))});if(i)return t();var s=this.validate();return r.onSubmit&&!r.onSubmit(s.errors,n)?t():s.errors?t():r.onSubmitValid&&!r.onSubmitValid(n)?t():!1},S.prototype.hasRequiredField=function(){var e=function(t){if(!t)return null;if(t.required&&t.type!=="boolean")return t;var n=r.find(t.properties,function(t){return e(t)});if(n)return n;if(t.items){r.isArray(t.items)?n=r.find(t.items,function(t){return e(t)}):n=e(t.items);if(n)return n}};return e(this.formDesc.schema)},f.getFormValue=function(e){var t=n(e).data("jsonform-tree");return t?t.root.getFormValues():null},n.fn.jsonFormErrors=function(e,t){n(".error",this).removeClass("error"),n(".has-error",this).removeClass("has-error"),n(".warning",this).removeClass("warning"),n(".jsonform-errortext",this).hide();if(!e)return;var r=[];for(var i=0;i<e.length;i++){var s=e[i].uri.replace(/.*#\//,"").replace(/\//g,".").replace(/\.([0-9]+)(?=\.|$)/g,"[$1]"),o=".jsonform-error-"+p(s.replace(/\./g,"---"));r.push(o);var u=e[i].type||"error";n(o,this).addClass(u),n(o+" > .jsonform-errortext",this).html(e[i].message).show()}r=r.join(",");var a=n(r).get(0);a&&a.scrollIntoView&&a.scrollIntoView(!0,{behavior:"smooth"})},n.fn.jsonForm=function(e){var t=this;l=e.resourceId,c=e.ouId,e=r.defaults({},e,{submitEvent:"submit"});var s=new S;return s.initialize(e),s.render(t.get(0)),e.transloadit&&t.append('<input type="hidden" name="params" value=\''+h(i.stringify(e.transloadit.params))+"'>"),t.data("jsonform-tree",s),e.submitEvent&&(t.unbind(e.submitEvent+".jsonform"),t.bind(e.submitEvent+".jsonform",function(e){s.submit(e)})),d(t),n(".expandable > div, .expandable > fieldset",t).hide(),n(".expandable > legend",t).click(function(){var e=n(this).parent();e.toggleClass("expanded"),n("> div",e).slideToggle(100)}),s},n.fn.jsonFormValue=function(){return f.getFormValue(this)},t.JSONForm=t.JSONForm||{util:{}},t.JSONForm.getFormValue=f.getFormValue,t.JSONForm.fieldTemplate=f.fieldTemplate,t.JSONForm.fieldTypes=f.elementTypes,t.JSONForm.getInitialValue=w,t.JSONForm.util.getObjKey=f.util.getObjKey,t.JSONForm.util.setObjKey=f.util.setObjKey})(typeof exports!="undefined",typeof exports!="undefined"?exports:window,typeof jQuery!="undefined"?jQuery:{fn:{}},typeof _!="undefined"?_:null,JSON);
