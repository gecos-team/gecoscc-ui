!function(e,r,f,p,d){e&&(p=require("underscore"));var v,g,i,m=/\[([0-9]*)\](?=\[|\.|$)/g,a={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},h={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g},c=function(e){return!(p.isUndefined(e)||p.isNull(e))},u={util:{}},s=function(e){return c(e)&&(e=""+e)?e.replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):""},y=function(e){return e.replace(/([ \!\"\#\$\%\&\'\(\)\*\+\,\.\/\:\;<\=\>\?\@\[\\\]\^\`\{\|\}\~])/g,"\\$1")},l=function(e){var l=function(e,t){t.find("> .active").removeClass("active"),e.addClass("active")},r=function(e,t){e.find("input, textarea, select").removeAttr("disabled"),e.parent().children(":not([data-idx="+t+"])").find("input, textarea, select").attr("disabled","disabled")},t=function(e){var t,n=f("option:selected",f(this)),i=f(this),a=n.get(0).getAttribute("data-idx")||n.attr("value");e.preventDefault(),n.hasClass("active")||(t=f(this).parents(".tabbable").eq(0).find(".tab-content [data-idx="+a+"]"),l(n,i),l(t,t.parent()),r(t,a))},n=function(e){f("a",f(this));var t=f(this).parents(".tabbable").first().find(".tab-content").first(),n=f(this).index(),i=t.find("[data-idx="+n+"]");e.preventDefault(),l(f(this),f(this).parent()),l(i,i.parent()),f(this).parent().hasClass("jsonform-alternative")&&r(i,n)};e.each(function(){f(this).delegate("select.nav","change",t),f(this).find("select.nav").each(function(){f(this).val(f(this).find(".active").attr("value"));var e=f(this).find("option:selected").get(0).getAttribute("data-idx")||f(this).find("option:selected").attr("value"),t=f(this).parents(".tabbable").eq(0).find(".tab-content [data-idx="+e+"]");r(t,e)}),f(this).delegate("ul.nav li","click",n),f(this).find("ul.nav li.active").click()})};u.fieldTemplate=function(e){return'<div class="form-group jsonform-error-<%= keydash %><%= elt.htmlClass ? " " + elt.htmlClass : "" %><%= (node.schemaElement && node.schemaElement.required && (node.schemaElement.type !== "boolean") ? " jsonform-required" : "") %><%= (node.readOnly ? " jsonform-readonly" : "") %><%= (node.disabled ? " jsonform-disabled" : "") %>"><% if (node.title && !elt.notitle) { %><label class="col-sm-2 control-label" for="<%= node.id %>"><%= node.getLocalizedAttr("title") %></label><% } %><div class="<% if (!(node.title && !elt.notitle)) { print("col-sm-11 "); } else { print("col-sm-9 "); }%><% if (node.prepend || node.append) { print("input-group"); } %>"><% if (node.prepend) { %><span class="input-group-addon"><%= node.prepend %></span><% } %>'+e+'<% if (node.append) { %><span class="input-group-addon"><%= node.append %></span><% } %><% if (node.description) { %><span class="help-block"><%= node.getLocalizedAttr("description") %></span><% } %></div><span class="help-block jsonform-errortext text-danger col-sm-9 col-sm-offset-2" style="display:none;"></span></div>'};var t='<div class="_jsonform-preview"><% if (value.type=="image") { %><img class="jsonform-preview" id="jsonformpreview-<%= id %>" src="<%= value.url %>" /><% } else { %><a href="<%= value.url %>"><%= value.name %></a> (<%= Math.ceil(value.size/1024) %>kB)<% } %></div><a href="#" class="btn _jsonform-delete"><i class="icon-remove" title="Remove"></i></a> ',n=function(e){return{template:'<input type="'+e+'" class="form-control <% if (fieldHtmlClass) { print(fieldHtmlClass); } %>" name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%><%= (node.readOnly ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.schemaElement && node.schemaElement.required && (node.schemaElement.type !== "boolean") ? " required=\'required\'" : "") %><%= (node.placeholder? "placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%> />',fieldtemplate:!0,inputfield:!0}};u.elementTypes={none:{template:""},root:{template:"<div><%= children %></div>"},text:n("text"),password:n("password"),date:n("date"),datetime:n("datetime"),"datetime-local":n("datetime-local"),email:n("email"),month:n("month"),number:n("number"),search:n("search"),tel:n("tel"),time:n("time"),url:n("url"),week:n("week"),range:{template:'<input type="range" <%= (fieldHtmlClass ? "class=\'" + fieldHtmlClass + "\' " : "") %>name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%> min=<%= range.min %> max=<%= range.max %> step=<%= range.step %><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %> />',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(e,t){e.range={min:1,max:100,step:1},t&&t.schemaElement&&(t.formElement&&t.formElement.step&&(e.range.step=t.formElement.step),void 0!==t.schemaElement.minimum&&(t.schemaElement.exclusiveMinimum?e.range.min=t.schemaElement.minimum+e.range.step:e.range.min=t.schemaElement.minimum),void 0!==t.schemaElement.maximum&&(t.schemaElement.exclusiveMaximum?e.range.max=t.schemaElement.maximum+e.range.step:e.range.max=t.schemaElement.maximum))}},color:{template:'<input type="text" <%= (fieldHtmlClass ? "class=\'" + fieldHtmlClass + "\' " : "") %>name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %> />',fieldtemplate:!0,inputfield:!0,onInsert:function(e,t){f(t.el).find("#"+y(t.id)).spectrum({preferredFormat:"hex",showInput:!0})}},textarea:{template:'<textarea id="<%= id %>" name="<%= node.name %>" class="form-control" style="height:<%= elt.height || "150px" %>;width:<%= elt.width || "100%" %>;"<%= (node.disabled? " disabled" : "")%><%= (node.readOnly ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %><%= (node.placeholder? "placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%>><%= value %></textarea>',fieldtemplate:!0,inputfield:!0},wysihtml5:{template:'<textarea id="<%= id %>" name="<%= node.name %>" style="height:<%= elt.height || "300px" %>;width:<%= elt.width || "100%" %>;"<%= (node.disabled? " disabled" : "")%><%= (node.readOnly ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %><%= (node.placeholder? "placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%>><%= value %></textarea>',fieldtemplate:!0,inputfield:!0,onInsert:function(e,t){var n=function(){f(t.el).data("wysihtml5")||(f(t.el).data("wysihtml5_loaded",!0),f(t.el).find("#"+y(t.id)).wysihtml5({html:!0,link:!0,"font-styles":!0,image:!0,events:{load:function(){f(this.textareaElement).removeAttr("required")}}}))};if(window.jsonform_wysihtml5_setup)window.jsonform_wysihtml5_setup(n);else var i=window.setInterval(function(){window.wysihtml5&&(window.clearInterval(i),n())},1e3)}},ace:{template:'<div id="<%= id %>" style="position:relative;height:<%= elt.height || "300px" %>;"><div id="<%= id %>__ace" style="width:<%= elt.width || "100%" %>;height:<%= elt.height || "300px" %>;"></div><input type="hidden" name="<%= node.name %>" id="<%= id %>__hidden" value="<%= escape(value) %>"/></div>',fieldtemplate:!0,inputfield:!0,onInsert:function(e,a){var t=function(){var e=a.formElement||{},t=window.ace.edit(f(a.el).find("#"+y(a.id)+"__ace").get(0)),n="#"+y(a.id)+"__hidden";t.getSession().setNewLineMode("unix"),t.renderer.setShowPrintMargin(!1),t.setTheme("ace/theme/"+(e.aceTheme||"twilight")),e.aceMode&&t.getSession().setMode("ace/mode/"+e.aceMode),t.getSession().setTabSize(2),t.getSession().setValue(a.value||"");var i=p.debounce(function(){f(a.el).find(n).val(t.getSession().getValue()),f(a.el).find(n).change()},600);t.getSession().on("change",i),t.on("blur",function(){f(a.el).find(n).change(),f(a.el).find(n).trigger("blur")}),t.on("focus",function(){f(a.el).find(n).trigger("focus")})};if(window.jsonform_ace_setup)window.jsonform_ace_setup(t);else var n=window.setInterval(function(){window.ace&&(window.clearInterval(n),t())},1e3)}},checkbox:{template:'<div class="checkbox"><label><input type="checkbox" id="<%= id %>" name="<%= node.name %>" value="1" <% if (value) {%>checked<% } %><%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required && (node.schemaElement.type !== "boolean") ? " required=\'required\'" : "") %> /><%= node.inlinetitle || "" %></label></div>',fieldtemplate:!0,inputfield:!0,onInsert:function(e,t){if(t.formElement.toggleNext){var n=!0===t.formElement.toggleNext?1:t.formElement.toggleNext,i="jsonform-toggle-next jsonform-toggle-next-"+n,a=1===n?f(t.el).parent().next():"all"===n?f(t.el).parent().nextAll():f(t.el).parent().nextAll().slice(0,n);a.addClass("jsonform-toggle-next-target"),f(t.el).addClass(i).find(":checkbox").on("change",function(){var e=f(this).is(":checked");f(t.el).toggleClass("checked",e),a.toggle(e).toggleClass("jsonform-toggled-visible",e)}).change()}},getElement:function(e){return f(e).parent().get(0)}},file:{template:'<input class="input-file" id="<%= id %>" name="<%= node.name %>" type="file" <%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %>/>',fieldtemplate:!0,inputfield:!0},"file-hosted-public":{template:"<span><% if (value && (value.type||value.url)) { %>"+t+'<% } %><input class="input-file" id="_transloadit_<%= id %>" type="file" name="<%= transloaditname %>" /><input data-transloadit-name="_transloadit_<%= transloaditname %>" type="hidden" id="<%= id %>" name="<%= node.name %>" value=\'<%= escape(JSON.stringify(node.value)) %>\' /></span>',fieldtemplate:!0,inputfield:!0,getElement:function(e){return f(e).parent().get(0)},onBeforeRender:function(e,t){t.ownerTree._transloadit_generic_public_index?t.ownerTree._transloadit_generic_public_index++:t.ownerTree._transloadit_generic_public_index=1,e.transloaditname="_transloadit_jsonform_genericupload_public_"+t.ownerTree._transloadit_generic_public_index,t.ownerTree._transloadit_generic_elts||(t.ownerTree._transloadit_generic_elts={}),t.ownerTree._transloadit_generic_elts[e.transloaditname]=t},onChange:function(e,a){if(a.ownerTree._transloadit_bound)return!1;a.ownerTree._transloadit_bound=!0;var l=f(a.ownerTree.domRoot);l.transloadit({autoSubmit:!1,wait:!0,onSuccess:function(e){var t=p.values(e.results);t=p.flatten(t),p.each(t,function(t){var e=a.ownerTree._transloadit_generic_elts[t.field].id,n=l.find("#"+y(e)),i=p.filter(p.keys(t.meta),function(e){return!!c(t.meta[e])});t.meta=p.pick(t.meta,i),n.val(d.stringify(t))}),a.ownerTree._transloadit_bound=!1,l.unbind("submit.transloadit"),p.delay(function(){console.log("submit form"),a.ownerTree.submit()},10)},onError:function(e){console.log("assembly error",e)}})},onInsert:function(e,t){f(t.el).find("a._jsonform-delete").on("click",function(e){return f(t.el).find("._jsonform-preview").remove(),f(t.el).find("a._jsonform-delete").remove(),f(t.el).find("#"+y(t.id)).val(""),e.preventDefault(),!1})},onSubmit:function(e,t){return!t.ownerTree._transloadit_bound}},"file-transloadit":{template:"<span><% if (value && (value.type||value.url)) { %>"+t+'<% } %><input class="input-file" id="_transloadit_<%= id %>" type="file" name="_transloadit_<%= node.name %>" /><input type="hidden" id="<%= id %>" name="<%= node.name %>" value=\'<%= escape(JSON.stringify(node.value)) %>\' /></span>',fieldtemplate:!0,inputfield:!0,getElement:function(e){return f(e).parent().get(0)},onChange:function(e,n){if(n.ownerTree._transloadit_bound)return!1;n.ownerTree._transloadit_bound=!0;var i=f(n.ownerTree.domRoot);i.transloadit({autoSubmit:!1,wait:!0,onSuccess:function(e){var t=p.values(e.results);t=p.flatten(t),p.each(t,function(t){var e=i.find('input[name="'+t.field.replace(/^_transloadit_/,"")+'"]'),n=p.filter(p.keys(t.meta),function(e){return!!c(t.meta[e])});t.meta=p.pick(t.meta,n),e.val(d.stringify(t))}),n.ownerTree._transloadit_bound=!1,i.unbind("submit.transloadit"),p.delay(function(){console.log("submit form"),n.ownerTree.submit()},10)},onError:function(e){console.log("assembly error",e)}})},onInsert:function(e,t){f(t.el).find("a._jsonform-delete").on("click",function(e){return f(t.el).find("._jsonform-preview").remove(),f(t.el).find("a._jsonform-delete").remove(),f(t.el).find("#"+y(t.id)).val(""),e.preventDefault(),!1})},onSubmit:function(e,t){return!t.ownerTree._transloadit_bound}},select:{template:'<<%= (((node.parentNode.schemaElement && node.parentNode.schemaElement.autocomplete_url) || node.schemaElement.autocomplete_url) ? "input" : "select") %> name="<%= node.name %>" id="<%= id %>"class="form-control <% if (fieldHtmlClass) { print(fieldHtmlClass); } %>"<%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %>> <% if (!((node.parentNode.schemaElement && node.parentNode.schemaElement.autocomplete_url) || node.schemaElement.autocomplete_url)) { %><% _.each(node.options, function(key, val) { if(key instanceof Object) { if (value === key.value) { %><option selected value="<%= key.value %>"><%= key.title %></option> <% } else { %> <option value="<%= key.value %>"><%= key.title %></option> <% }} else { if (value === key) { %> <option selected value="<%= key %>"><%= key %></option> <% } else { %><option value="<%= key %>"><%= key %></option><% }}}); %> <% } %> </<%= (((node.parentNode.schemaElement && node.parentNode.schemaElement.autocomplete_url) || node.schemaElement.autocomplete_url)? "input" : "select") %>>',fieldtemplate:!0,inputfield:!0,onInsert:function(e,l){var t,r,s,a,o=l.parentNode.schemaElement&&l.parentNode.schemaElement.autocomplete_url?l.parentNode.schemaElement:l.schemaElement,d={},m="",n={},h=!1,c=function(e,t){(h=!p.some(e,function(e){return e.text==t}))&&(e.push({text:t,value:t,id:t}),l.schemaElement.enum.push(t))},u=function(){return"package"===i};!o||p.isUndefined(o)||p.isUndefined(o.autocomplete_url)||(l.value&&!o.autocomplete_url.startsWith("javascript:")?(f(l.el).addClass("hidden"),n=u()?{name:l.value}:{oids:l.value},t=f.ajax({url:o.autocomplete_url,dataType:"json",data:n})):(t=f.Deferred()).resolve(),f(l.el).append('<div class="alert alert-warning">'+gettext("Package not found in server repositories")+"</div>"),f(l.el).find(".alert").hide(),t.done(function(e){if(!p.isUndefined(e))if(void 0!==e.settings){nodes=[];var t=e.settings[0].value.replace(/[\[\]"]/g,"").split(",");if(0===t.length)return l.schemaElement.enum.push(l.value),f(l.el).find("input").attr("value",l.value),p.isUndefined(e.packages)||(a={name:l.value},f(l.el).find(".alert").show()),void f(l.parentNode.el).find(".array-warning-message").removeClass("hidden");a={name:t[0],_id:t[0]}}else{var n=e.nodes||e.packages||e.software_profiles;if(0===n.length){if(l.schemaElement.enum.push(l.value),f(l.el).find("input").attr("value",l.value),p.isUndefined(e.packages))return void f(l.parentNode.el).find(".array-warning-message").removeClass("hidden");a={name:l.value},f(l.el).find(".alert").show()}else a=n[0]}if(f(l.el).find("input").html(""),o.autocomplete_url.startsWith("javascript:")){var i=o.autocomplete_url.split(":")[1];f(l.el).find("input").select2({query:function(e){window[i](l,e)},initSelection:function(e,t){p.isUndefined(l.value)||(f(l.el).find("input").last().attr("value",l.value),l.schemaElement.enum.push(l.value),t({id:l.value,value:l.value,text:gettext(l.value)}))}})}else f(l.el).find("input").select2({query:function(a){m.length<a.term.length&&!r?(s=p.filter(s,function(e){return new RegExp(a.term+".*","i").test(e.text)}),d[a.term]=p.clone(s),u()&&c(s,a.term),a.callback({results:s})):d[a.term]?(u()&&c(d[a.term],a.term),a.callback({results:d[a.term]})):f.ajax({url:o.autocomplete_url,dataType:"json",id:function(e){return e._id},data:{item_id:v,ou_id:g,iname:a.term,page:a.page,pagesize:30},type:"GET",success:function(e){if(void 0!==e.settings){nodes=[];for(var t=e.settings[0].value.replace(/[\[\]"]/g,"").split(","),n=0;n<t.length;n++)nodes[n]={text:t[n],value:t[n],id:t[n]},l.schemaElement.enum.push(t[n]);r=30<=t.length}else{var i=e.software_profiles||e.nodes||e.packages;nodes=i.map(function(e){return e._id=e._id||e.name,l.schemaElement.enum.push(e._id),{text:e.name,value:e._id,id:e._id}}),r=30<=i.length}s=1===e.page?nodes:p.union(s,nodes),a.callback({results:nodes,more:r})}}),m=a.term},initSelection:function(e,t){p.isUndefined(a)||(f(l.el).find("input").last().attr("value",a._id||a.name),l.schemaElement.enum.push(a._id||a.name),t({id:a._id||a.name,text:a.name}))}}).on("change",function(e){e.val==m&&h?f(l.el).find(".alert").show():f(l.el).find(".alert").hide()});f(l.el).removeClass("hidden")}))}},imageselect:{template:'<div><input type="hidden" name="<%= node.name %>" id="<%= node.id %>" value="<%= value %>" /><div class="dropdown"><a class="btn<% if (buttonClass && node.value) { %> <%= buttonClass %><% } %>" data-toggle="dropdown" href="#"<% if (node.value) { %> style="max-width:<%= width %>px;max-height:<%= height %>px"<% } %>><% if (node.value) { %><img src="<% if (!node.value.match(/^https?:/)) { %><%= prefix %><% } %><%= node.value %><%= suffix %>" alt="" /><% } else { %><%= buttonTitle %><% } %></a><div class="dropdown-menu navbar" id="<%= node.id %>_dropdown"><div><% _.each(node.options, function(key, idx) { if ((idx > 0) && ((idx % columns) === 0)) { %></div><div><% } %><a class="btn<% if (buttonClass) { %> <%= buttonClass %><% } %>" style="max-width:<%= width %>px;max-height:<%= height %>px"><% if (key instanceof Object) { %><img src="<% if (!key.value.match(/^https?:/)) { %><%= prefix %><% } %><%= key.value %><%= suffix %>" alt="<%= key.title %>" /></a><% } else { %><img src="<% if (!key.match(/^https?:/)) { %><%= prefix %><% } %><%= key %><%= suffix %>" alt="" /><% } %></a> <% }); %></div><div class="pagination-right"><a class="btn">Reset</a></div></div></div></div>',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(e,t){var n=t.formElement||{},i=null,a=n.imageSelectorColumns||5;e.buttonTitle=n.imageSelectorTitle||"Select...",e.prefix=n.imagePrefix||"",e.suffix=n.imageSuffix||"",e.width=n.imageWidth||32,e.height=n.imageHeight||32,e.buttonClass=n.imageButtonClass||!1,t.options.length>a?(i=Math.ceil(t.options.length/a),e.columns=Math.ceil(t.options.length/i)):e.columns=a},getElement:function(e){return f(e).parent().get(0)},onInsert:function(e,s){f(s.el).on("click",".dropdown-menu a",function(e){e.preventDefault(),e.stopPropagation();var t=("img"===e.target.nodeName.toLowerCase()?f(e.target):f(e.target).find("img")).attr("src"),n=s.formElement||{},i=n.imagePrefix||"",a=n.imageSuffix||"",l=n.imageWidth||32,r=n.imageHeight||32;t?(0===t.indexOf(i)&&(t=t.substring(i.length)),t=t.substring(0,t.length-a.length),f(s.el).find("input").attr("value",t),f(s.el).find('a[data-toggle="dropdown"]').addClass(n.imageButtonClass).attr("style","max-width:"+l+"px;max-height:"+r+"px").html('<img src="'+(t.match(/^https?:/)?"":i)+t+a+'" alt="" />')):(f(s.el).find("input").attr("value",""),f(s.el).find('a[data-toggle="dropdown"]').removeClass(n.imageButtonClass).removeAttr("style").html(n.imageSelectorTitle||"Select..."))})}},radios:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><div class="radio"><label><input type="radio" <% if (((key instanceof Object) && (value === key.value)) || (value === key)) { %> checked="checked" <% } %> name="<%= node.name %>" value="<%= (key instanceof Object ? key.value : key) %>"<%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %>/><%= (key instanceof Object ? key.title : key) %></label></div><% }); %></div>',fieldtemplate:!0,inputfield:!0},radiobuttons:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><div class="radio"><label class="radio btn"><input type="radio" style="position:absolute;left:-9999px;" <% if (((key instanceof Object) && (value === key.value)) || (value === key)) { %> checked="checked" <% } %> name="<%= node.name %>" value="<%= (key instanceof Object ? key.value : key) %>" /><%= (key instanceof Object ? key.title : key) %></label></div><% }); %></div>',fieldtempate:!0,inputfield:!0,onInsert:function(e,t){var n="active",i=t.formElement||{};i.activeClass&&(n+=" "+i.activeClass),f(t.el).find("label").on("click",function(){f(this).parent().find("label").removeClass(n),f(this).addClass(n)})}},checkboxes:{template:'<div class="checkbox"><%= choiceshtml %></div>',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(e,n){var t,i=null;n&&n.schemaElement&&n.schemaElement.items&&(t=n.schemaElement.items.enum||n.schemaElement.items[0].enum)&&(i="",p.each(t,function(e,t){i+=p.template('<label><input type="checkbox" <% if (value) { %> checked="checked" <% } %> name="<%= name %>" value="1"<%= (node.disabled? " disabled" : "")%>/> <%= title %></label>',{name:n.key+"["+t+"]",value:p.include(n.value,e),title:n.formElement.titleMap?n.formElement.titleMap[e]:e,node:n},a)}),e.choiceshtml=i)}},array:{template:'<div id="<%= id %>"><input type="hidden" name="<%= node.name %>" value="[]" /><ul class="_jsonform-array-ul" style="list-style-type:none;"><%= children %></ul><span class="_jsonform-array-buttons"><a href="#" class="btn btn-default btn-xs _jsonform-array-addmore"><span class="fa fa-plus" title="Add new"></span></a> </span></div> <div class="col-sm-12 array-warning-message hidden"><div class="alert alert-warning"></div></div>',fieldtemplate:!0,array:!0,childTemplate:function(e){return f("").sortable?'<li data-idx="<%= node.childPos %>"><span class="draggable line"><i class="icon-list" title="Move item"></i></span>'+e+"</li>":'<li class=<% if (_.isUndefined(node.title) || node.type !== "object") { %> "col-sm-12 separator" <% } else { %> "col-sm-offset-1 col-sm-11 separator" <% } %>data-idx="<%= node.childPos %>"><a href="#" class="pull-right btn btn-default btn-xs _jsonform-array-deleteidx"><span class="fa fa-minus" title="Delete item"></span></a>'+e+"</li>"},onInsert:function(e,s){var o=f(s.el).find("#"+y(s.id)),n=s.getArrayBoundaries();s.resetDeleteEvents();var t=s.schemaElement&&(s.schemaElement["title_"+App.language]||s.title)+" "+gettext("contains items that are outside your scope, please consult a global administrator if you need more information.");f(s.el).find(".alert-warning").html(t);f("> span > a._jsonform-array-addmore",o).click(function(e){e.preventDefault(),e.stopPropagation();var t=s.children.length;if(0<=n.maxItems&&(s.children.length>n.maxItems-2&&o.find("> span > a._jsonform-array-addmore").addClass("disabled"),s.children.length>n.maxItems-1))return!1;s.insertArrayItem(t,f("> ul",o).get(0)),JSONForm.initializeTabs(f("form")),(n.minItems<=0||0<n.minItems&&s.children.length>n.minItems-1)&&o.find("> span > a._jsonform-array-deletelast").removeClass("disabled")});var i=f("> ul > li",o).length;if(0<n.minItems&&i<n.minItems)for(var a=0;a<n.minItems-1&&o.find("> ul > li").length<n.minItems;a++)s.insertArrayItem(i,o.find("> ul").get(0));0<n.minItems&&s.children.length<=n.minItems&&o.find("> span > a._jsonform-array-deletelast").addClass("disabled"),f("> span > a._jsonform-array-deletelast",o).click(function(e){var t=s.children.length-1;if(e.preventDefault(),e.stopPropagation(),0<n.minItems){if(s.children.length<n.minItems+2&&o.find("> span > a._jsonform-array-deletelast").addClass("disabled"),s.children.length<=n.minItems)return!1}else 1===s.children.length&&o.find("> span > a._jsonform-array-deletelast").addClass("disabled");s.deleteArrayItem(t),0<=n.maxItems&&t<=n.maxItems-1&&o.find("> span > a._jsonform-array-addmore").removeClass("disabled")}),f(s.el).sortable&&(f("> ul",o).sortable(),f("> ul",o).bind("sortstop",function(e,t){!function(e,t){if(e!==t){var n=e<t?1:-1,i=0,a=f("> ul",o);for(i=e;i!==t;i+=n)s.children[i].switchValuesWith(s.children[i+n]),s.children[i].render(a.get(0)),s.children[i+n].render(a.get(0));var l=f(s.children[e].el),r=f(s.children[t].el);l.detach(),r.detach(),e<t?(0===e?a.prepend(l):f(s.children[e-1].el).after(l),f(s.children[t-1].el).after(r)):(0===t?a.prepend(r):f(s.children[t-1].el).after(r),f(s.children[e-1].el).after(l))}}(f(t.item).data("idx"),f(t.item).index())})),p.each(f(s.el).find("li"),function(e){f(e).find(".collapse").first().removeClass("collapse")})}},tabarray:{template:'<div id="<%= id %>"><div class="tabbable tabs-left"><ul class="nav nav-tabs"><%= tabs %></ul><div class="tab-content"><%= children %></div></div><a href="#" class="btn btn-default btn-xs _jsonform-array-addmore"><span class="fa fa-plus" title="Add new"></span></a> <a href="#" class="btn btn-default btn-xs _jsonform-array-deleteitem"><span class="fa fa-minus" title="Delete item"></span></a></div>',fieldtemplate:!0,array:!0,childTemplate:function(e){return'<div data-idx="<%= node.childPos %>" id="<%= node.childPos %>" class="tab-pane">'+e+"</div>"},onBeforeRender:function(e,t){var i="";p.each(t.children,function(e,t){var n=e.legend||e.title||"Item "+(t+1);i+='<li data-idx="'+t+'"'+(0===t?' class="active"':"")+'><a href="#'+t+'" class="draggable tab" data-toggle="tab">'+s(n)+"</a></li>"}),e.tabs=i},onInsert:function(e,l){var r=f(l.el).find("#"+y(l.id)),n=l.getArrayBoundaries(),a=function(e){var i="",t=!1;void 0===e&&((e=f("> .tabbable > .nav-tabs .active",r).data("idx"))?e=parseInt(e,10):(t=!0,e=0)),e>=l.children.length&&(e=l.children.length-1),p.each(l.children,function(e,t){var n=e.legend||e.title||"Item "+(t+1);i+='<li data-idx="'+t+'"><a href="#'+t+'" class="draggable tab" data-toggle="tab">'+s(n)+"</a></li>"}),f("> .tabbable > .nav-tabs",r).html(i),t&&f('> .tabbable > .nav-tabs [data-idx="0"]',r).addClass("active"),f('> .tabbable > .nav-tabs [data-toggle="tab"]',r).eq(e).click()};if(f("> a._jsonform-array-deleteitem",r).click(function(e){var t=f("> .tabbable > .nav-tabs .active",r).data("idx");if(e.preventDefault(),e.stopPropagation(),0<n.minItems&&(l.children.length<n.minItems+1&&r.find("> a._jsonform-array-deleteitem").addClass("disabled"),l.children.length<=n.minItems))return!1;l.deleteArrayItem(t),a(),(l.children.length<n.minItems+1||0===l.children.length)&&r.find("> a._jsonform-array-deleteitem").addClass("disabled"),0<=n.maxItems&&l.children.length<=n.maxItems&&r.find("> a._jsonform-array-addmore").removeClass("disabled")}),f("> a._jsonform-array-addmore",r).click(function(e){var t=l.children.length;if(0<=n.maxItems&&(l.children.length>n.maxItems-2&&f("> a._jsonform-array-addmore",r).addClass("disabled"),l.children.length>n.maxItems-1))return!1;e.preventDefault(),e.stopPropagation(),l.insertArrayItem(t,r.find("> .tabbable > .tab-content").get(0)),a(t),(n.minItems<=0||0<n.minItems&&t>n.minItems-1)&&r.find("> a._jsonform-array-deleteitem").removeClass("disabled")}),f(l.el).on("legendUpdated",function(e){a(),e.preventDefault(),e.stopPropagation()}),f(l.el).sortable&&(f("> .tabbable > .nav-tabs",r).sortable({containment:l.el,tolerance:"pointer"}),f("> .tabbable > .nav-tabs",r).bind("sortstop",function(e,t){var n=f(t.item).data("idx"),i=f(t.item).index();!function(e,t){if(e!==t){var n=e<t?1:-1,i=0,a=f("> .tabbable > .tab-content",r).get(0);for(i=e;i!==t;i+=n)l.children[i].switchValuesWith(l.children[i+n]),l.children[i].render(a),l.children[i+n].render(a)}}(n,i),a(i)})),0<=n.minItems){for(var t=0;t<n.minItems-1;t++)r.find("> a._jsonform-array-addmore").click();r.find("> a._jsonform-array-deleteitem").addClass("disabled"),a()}0<=n.maxItems&&l.children.length>=n.maxItems&&r.find("> a._jsonform-array-addmore").addClass("disabled"),0<=n.minItems&&l.children.length<=n.minItems&&r.find("> a._jsonform-array-deleteitem").addClass("disabled")}},help:{template:'<span class="help-block" style="padding-top:5px"><%= elt.helpvalue %></span>',fieldtemplate:!0},msg:{template:"<%= elt.msg %>"},fieldset:{template:'<fieldset class="jsonform-error-<%= keydash %> <% if (elt.expandable) { %>expandable<% } %> <%= elt.htmlClass?elt.htmlClass:"" %>" <% if (id) { %> id="<%= id %>"<% } %>><% if (node.title || node.legend) { %><legend><span id="caret" class="fa fa-caret-right"></span> <%= node.getLocalizedAttr("title") || node.legend %></legend><% } %><div <% if (node.title || node.legend) { %> class="collapse" <% } %>><%= children %></div></fieldset>'},advancedfieldset:{template:'<fieldset<% if (id) { %> id="<%= id %>"<% } %> class="expandable <%= elt.htmlClass?elt.htmlClass:"" %>"><legend>Advanced options</legend><div><%= children %></div></fieldset>'},authfieldset:{template:'<fieldset<% if (id) { %> id="<%= id %>"<% } %> class="expandable <%= elt.htmlClass?elt.htmlClass:"" %>"><legend>Authentication settings</legend><div><%= children %></div></fieldset>'},submit:{template:'<input type="submit" <% if (id) { %> id="<%= id %>" <% } %> class="btn btn-primary <%= elt.htmlClass?elt.htmlClass:"" %>" value="<%= value || node.title %>"<%= (node.disabled? " disabled" : "")%>/>'},button:{template:' <button <% if (id) { %> id="<%= id %>" <% } %> class="btn <%= elt.htmlClass?elt.htmlClass:"btn-default" %>"><%= node.getLocalizedAttr("title") %></button> '},actions:{template:'<div class="<%= elt.htmlClass?elt.htmlClass:"" %>"><%= children %></div>'},hidden:{template:'<input type="hidden" id="<%= id %>" name="<%= node.name %>" value="<%= escape(value) %>" />',inputfield:!0},selectfieldset:{template:'<fieldset class="tab-container <%= elt.htmlClass?elt.htmlClass:"" %>"><% if (node.legend) { %><legend><%= node.legend %></legend><% } %><% if (node.formElement.key) { %><input type="hidden" id="<%= node.id %>" name="<%= node.name %>" value="<%= escape(value) %>" /><% } else { %><a id="<%= node.id %>"></a><% } %><div class="tabbable"><div class="control-group<%= node.formElement.hideMenu ? " hide" : " control-group-action" %>"><% if (node.title && !elt.notitle) { %><label class="col-sm-2 control-label control-label-action" for="<%= node.id %>"><%= node.getLocalizedAttr("title") %></label><% } %><div class="controls col-sm-9"><%= tabs %></div></div><div class="tab-content"><%= children %></div></div></fieldset>',inputfield:!0,getElement:function(e){return f(e).parent().get(0)},childTemplate:function(e){return'<div data-idx="<%= node.childPos %>" class="tab-pane<% if (node.active) { %> active<% } %>">'+e+"</div>"},onBeforeRender:function(e,i){var t=null,a=[];i.schemaElement&&(a=i.schemaElement.enum||[]),t=i.options?p.map(i.options,function(e,t){var n=i.children[t];return n.childPos=t,e instanceof Object?((e=p.extend({node:n},e)).title=e.title||n.legend||n.title||"Option "+(n.childPos+1),e.value=c(e.value)?e.value:c(a[t])?a[t]:t,e):{title:e,value:c(a[n.childPos])?a[n.childPos]:n.childPos,node:n}}):p.map(i.children,function(e,t){return{title:e.legend||e.title||"Option "+(e.childPos+1),value:a[e.childPos]||e.childPos,node:e}});var n=null;e.value&&(n=p.find(t,function(e){return e.value===i.value})),n||(n=p.find(t,function(e){return e.node.hasNonDefaultValue()})),n||(n=t[0]),n.node.active=!0,e.value=n.value;i.formElement;var l='<select class="nav select-action"'+(i.disabled?" disabled":"")+">";return p.each(t,function(e,t){l+='<option data-idx="'+t+'" value="'+e.value+'"'+(e.node.active?' class="active"':"")+">"+s(e.title)+"</option>"}),l+="</select>",e.tabs=l,e},onInsert:function(e,n){f(n.el).find("select.nav").first().on("change",function(e){var t=f(this).find("option:selected");f(n.el).find('input[type="hidden"]').first().val(t.attr("value"))})}},optionfieldset:{template:'<div<% if (node.id) { %> id="<%= node.id %>"<% } %>><%= children %></div>'},section:{template:'<div<% if (node.id) { %> id="<%= node.id %>"<% } %>><%= children %></div>'},questions:{template:'<div><input type="hidden" id="<%= node.id %>" name="<%= node.name %>" value="<%= escape(value) %>" /><%= children %></div>',fieldtempate:!0,inputfield:!0,getElement:function(e){return f(e).parent().get(0)},onInsert:function(e,t){t.children&&0!==t.children.length&&(p.each(t.children,function(e){f(e.el).hide()}),f(t.children[0].el).show())}},question:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><div class="radio"><label class="<%= ((key instanceof Object && key.htmlClass) ? " " + key.htmlClass : "") %>"><input type="radio" <% if (node.formElement.optionsType === "radiobuttons") { %> style="position:absolute;left:-9999px;" <% } %>name="<%= node.id %>" value="<%= val %>"<%= (node.disabled? " disabled" : "")%>/><%= (key instanceof Object ? key.title : key) %></label></div><% }); %></div>',fieldtemplate:!0,onInsert:function(e,i){var a="active",t=i.formElement||{};t.activeClass&&(a+=" "+t.activeClass),f(i.el).find('input[type="radio"]').on("change",function(e){var t=null,n=i.options[f(this).val()];i.parentNode&&i.parentNode.el&&(f(this).parent().parent().find("label").removeClass(a),f(this).parent().addClass(a),f(i.el).nextAll().hide(),f(i.el).nextAll().find('input[type="radio"]').prop("checked",!1),n.value&&f(i.parentNode.el).find('input[type="hidden"]').val(n.value),n.next&&(t=p.find(i.parentNode.children,function(e){return e.formElement&&e.formElement.qid===n.next}),f(t.el).show(),f(t.el).nextAll().hide(),f(t.el).nextAll().find('input[type="radio"]').prop("checked",!1)),n.href&&(n.target?window.open(n.href,n.target):window.location=n.href),n.submit&&setTimeout(function(){i.ownerTree.submit()},0))})}}},u.util.getObjKey=function(e,t,n){for(var i=e,a=t.split("."),l=null,r=null,s=null,o=0;o<a.length;o++){if(null===i||"object"!=typeof i)return null;if(s=(l=a[o]).replace(m,""),m.lastIndex=0,r=m.exec(l))for(;;){if(!p.isArray(i[s]))return null;if(i=i[s][parseInt(r[1],10)],!(r=m.exec(l)))break}else i=n&&!i[s]&&p.isArray(i)&&i[0]?i[0][s]:i[s]}return n&&p.isArray(i)&&i[0]?i[0]:i},u.util.setObjKey=function(e,t,n){for(var i=e,a=t.split("."),l=null,r=null,s=null,o=0;o<a.length-1;o++)if(s=(l=a[o]).replace(m,""),m.lastIndex=0,r=m.exec(l)){for(;p.isArray(i[s])||(i[s]=[]),i=i[s],s=parseInt(r[1],10),r=m.exec(l););"object"==typeof i[s]&&null!==i[s]||(i[s]={}),i=i[s]}else"object"==typeof i[s]&&null!==i[s]||(i[s]={}),i=i[s];if(s=(l=a[a.length-1]).replace(m,""),m.lastIndex=0,r=m.exec(l)){for(;p.isArray(i[s])||(i[s]=[]),i=i[s],s=parseInt(r[1],10),r=m.exec(l););i[s]=n}else i[s]=n};var b=function(e,t){var n=t.replace(/\./g,".properties.").replace(/\[[0-9]*\]/g,".items"),i=u.util.getObjKey(e,n,!0);if(i&&i.$ref)throw new Error("JSONForm does not yet support schemas that use the $ref keyword. See: https://github.com/joshfire/jsonform/issues/54");return i},x=function(e,i){var a=0;return e?i&&0!==i.length?e.replace(m,function(e,t){var n=e;return c(i[a])&&(n="["+i[a]+"]"),a+=1,n}):e:null},w=function(t,e,n,i,a){var l=null;(i=i||{}).idx=i.idx||(n?n[n.length-1]:1),i.value=c(i.value)?i.value:"",i.getValue=i.getValue||function(e){return w(t,e,n,i,a)};var r=function(e,t){var n=null;return e&&e.length?(p.each(e,function(e){n||(e!==t?p.isString(e)||(e.key===t?n=e:e.items&&(n=r(e.items,t))):n={key:e})}),n):null},s=r(t.form||[],e),o=b(t.schema.properties,e);return a&&t.value&&(l=u.util.getObjKey(t.value,x(e,n))),c(l)||(s&&void 0!==s.value?l=s.value:o&&c(o.default)&&(l=o.default),l&&-1!==l.indexOf("{{values.")&&(l=l.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}')),l&&(l=p.template(l,i,h))),c(l)&&s&&s.titleMap&&s.titleMap[l]&&(l=p.template(s.titleMap[l],i,h)),l&&p.isString(l)&&o&&o.maxLength&&l.length>o.maxLength&&(l=l.substr(0,o.maxLength-1)+"â€¦"),c(l)?l:null},E=function(){this.id=null,this.key=null,this.el=null,this.formElement=null,this.schemaElement=null,this.view=null,this.children=[],this.ownerTree=null,this.parentNode=null,this.childTemplate=null,this.legendChild=null,this.arrayPath=[],this.childPos=0,this.lan=(window.navigator.language||navigator.browserLanguage).slice(0,2)};E.prototype.clone=function(e){var t=new E;return t.arrayPath=p.clone(this.arrayPath),t.ownerTree=this.ownerTree,t.parentNode=e||this.parentNode,t.formElement=this.formElement,t.schemaElement=this.schemaElement,t.view=this.view,t.children=p.map(this.children,function(e){return e.clone(t)}),this.childTemplate&&(t.childTemplate=this.childTemplate.clone(t)),t},E.prototype.hasNonDefaultValue=function(){return(!this.formElement||"hidden"!=this.formElement.type)&&(!(!this.value||this.defaultValue)||!!p.find(this.children,function(e){return e.hasNonDefaultValue()}))},E.prototype.appendChild=function(e){return e.parentNode=this,e.childPos=this.children.length,this.children.push(e),e},E.prototype.removeChild=function(){var e=this.children[this.children.length-1];if(e)return f(e.el).remove(),this.children.pop()},E.prototype.moveValuesTo=function(e){var t=this.getFormValues(e.arrayPath);e.resetValues(),e.computeInitialValues(t,!0)},E.prototype.switchValuesWith=function(e){var t=this.getFormValues(e.arrayPath),n=e.getFormValues(this.arrayPath);e.resetValues(),e.computeInitialValues(t,!0),this.resetValues(),this.computeInitialValues(n,!0)},E.prototype.resetValues=function(){var e=null;if(this.value=null,this.parentNode?(this.arrayPath=p.clone(this.parentNode.arrayPath),this.parentNode.view&&this.parentNode.view.array&&this.arrayPath.push(this.childPos)):this.arrayPath=[],this.view&&this.view.inputfield)e=f(":input",this.el).serializeArray(),p.each(e,function(e){f('[name="'+y(e.name)+'"]',f(this.el)).val("")},this);else if(this.view&&this.view.array)for(;0<this.children.length;)this.removeChild();p.each(this.children,function(e){e.resetValues()})},E.prototype.setChildTemplate=function(e){(this.childTemplate=e).parentNode=this},E.prototype.computeInitialValues=function(t,n){var i=this,e=null,a=1,l=0,r=this.ownerTree.formDesc.tpldata||{};if(this.parentNode?(this.arrayPath=p.clone(this.parentNode.arrayPath),this.parentNode.view&&this.parentNode.view.array&&this.arrayPath.push(this.childPos)):this.arrayPath=[],r.idx=0<this.arrayPath.length?this.arrayPath[this.arrayPath.length-1]+1:this.childPos+1,r.value="",r.getValue=function(e){return w(i.ownerTree.formDesc,e,i.arrayPath,r,!!t)},this.formElement&&(this.formElement.id?this.id=x(this.formElement.id,this.arrayPath):this.view&&this.view.array?this.id=y(this.ownerTree.formDesc.prefix)+"-elt-counter-"+p.uniqueId():this.parentNode&&this.parentNode.view&&this.parentNode.view.array?this.id=y(this.ownerTree.formDesc.prefix)+"-elt-counter-"+p.uniqueId():"button"!==this.formElement.type&&"selectfieldset"!==this.formElement.type&&"question"!==this.formElement.type&&"buttonquestion"!==this.formElement.type||(this.id=y(this.ownerTree.formDesc.prefix)+"-elt-counter-"+p.uniqueId()),this.formElement.key&&(this.key=x(this.formElement.key,this.arrayPath),this.keydash=this.key.replace(/\./g,"---")),this.name=x(this.formElement.name,this.arrayPath),p.each(["title","legend","description","append","prepend","inlinetitle","helpvalue","value","disabled","placeholder","readOnly"],function(e){p.isString(this.formElement[e])?(-1!==this.formElement[e].indexOf("{{values.")?this[e]=this.formElement[e].replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):this[e]=x(this.formElement[e],this.arrayPath),this[e]&&(this[e]=p.template(this[e],r,h))):this[e]=this.formElement[e]},this),this.formElement.options&&(this.options=p.map(this.formElement.options,function(e){var t=null;return p.isObject(e)&&e.title?(t=-1!==e.title.indexOf("{{values.")?e.title.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):x(e.title,i.arrayPath),p.extend({},e,{value:c(e.value)?e.value:"",title:p.template(t,r,h)})):e}))),this.view&&this.view.inputfield&&this.schemaElement)t?c(u.util.getObjKey(t,this.key))&&(this.value=u.util.getObjKey(t,this.key)):n||!c(this.value)&&c(this.schemaElement.default)&&(this.value=this.schemaElement.default,p.isString(this.value)&&(-1!==this.value.indexOf("{{values.")?this.value=this.value.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):this.value=x(this.value,this.arrayPath),this.value&&(this.value=p.template(this.value,r,h))),this.defaultValue=!0);else if(this.view&&this.view.array)for(a=0,t?a=this.getPreviousNumberOfItems(t,this.arrayPath):0===a&&(a=1),l=0;l<a;l++)this.appendChild(this.childTemplate.clone());if(p.each(this.children,function(e){e.computeInitialValues(t,n)}),this.formElement&&this.formElement.valueInLegend)for(e=this;e;){if(e.parentNode&&e.parentNode.view&&e.parentNode.view.array&&(e.legendChild=this,e.formElement&&e.formElement.legend)){e.legend=x(e.formElement.legend,e.arrayPath),r.idx=0<e.arrayPath.length?e.arrayPath[e.arrayPath.length-1]+1:e.childPos+1,r.value=c(this.value)?this.value:"",e.legend=p.template(e.legend,r,h);break}e=e.parentNode}},E.prototype.getPreviousNumberOfItems=function(t,n){var e=null,i=null,a=null;return t?this.view.inputfield&&this.schemaElement?(e=function(e,t){var n=0,i=0;if(!e)return null;if(0<t)for(;n<t;){if(-1===(i=e.indexOf("[]",i)))return e;i+=2,n+=1}return-1===(i=e.indexOf("[]",i))?e:e.substring(0,i)}(this.formElement.key,n.length),e=x(e,n),(i=u.util.getObjKey(t,e))?(a=p.map(this.children,function(e){return e.getPreviousNumberOfItems(t,n)}),p.max([p.max(a)||0,i.length])):0):this.view.array?this.childTemplate.getPreviousNumberOfItems(t,n):(a=p.map(this.children,function(e){return e.getPreviousNumberOfItems(t,n)}),p.max(a)||0):0},E.prototype.getFormValues=function(t){var e={};if(!this.el)throw new Error("formNode.getFormValues can only be called on nodes that are associated with a DOM element in the tree");var n=f(":input",this.el).serializeArray();n=n.concat(f(":input[type=checkbox]:not(:disabled):not(:checked)",this.el).map(function(){return{name:this.name,value:this.checked}}).get()),t&&p.each(n,function(e){e.name=x(e.name,t)});for(var i=this.ownerTree.formDesc.schema,a=0;a<n.length;a++){var l=n[a].name,r=b(i.properties,l),s=null,o=null;if(r)if(r._jsonform_checkboxes_as_array&&(s=l.match(/\[([0-9]*)\]$/)))l=l.replace(/\[([0-9]*)\]$/,""),o=u.util.getObjKey(e,l)||[],"1"===n[a].value&&o.push(r.enum[parseInt(s[1],10)]),u.util.setObjKey(e,l,o);else{if("boolean"===r.type&&("0"===n[a].value?n[a].value=!1:n[a].value=!!n[a].value),"number"!==r.type&&"integer"!==r.type||p.isString(n[a].value)&&(n[a].value.length?isNaN(Number(n[a].value))||(n[a].value=Number(n[a].value)):n[a].value=null),"string"!==r.type||""!==n[a].value||r._jsonform_allowEmpty||(n[a].value=null),"object"===r.type&&p.isString(n[a].value)&&"{"===n[a].value.substring(0,1))try{n[a].value=d.parse(n[a].value)}catch(e){n[a].value={}}"array"===r.type&&"[]"===n[a].value&&p.isUndefined(e[n[a].name])?u.util.setObjKey(e,n[a].name,[]):("object"!==r.type||"null"!==n[a].value&&""!==n[a].value||(n[a].value=null),n[a].name&&null!==n[a].value&&u.util.setObjKey(e,n[a].name,n[a].value))}}return e},E.prototype.render=function(e){var t=this.generate();this.setContent(t,e),this.enhance()},E.prototype.getLocalizedAttr=function(e,t){return t=t||this.lan,this.formElement[e+"_"+t]||this.schemaElement[e+"_"+t]||this[e]},E.prototype.setContent=function(e,t){var n=f(e),i=t||(this.parentNode?this.parentNode.el:this.ownerTree.domRoot),a=null;this.el?f(this.el).replaceWith(n):(a=f(i).children().get(this.childPos))?f(a).before(n):f(i).append(n),this.el=n,this.updateElement(this.el)},E.prototype.updateElement=function(t){this.id&&(this.el=f("#"+y(this.id),t).get(0),this.view&&this.view.getElement&&(this.el=this.view.getElement(this.el)),!1!==this.fieldtemplate&&this.view&&this.view.fieldtemplate&&(this.el=f(this.el).parent().parent(),(this.prepend||this.prepend)&&(this.el=this.el.parent()),this.el=this.el.get(0)),this.parentNode&&this.parentNode.view&&this.parentNode.view.childTemplate&&(this.el=f(this.el).parent().get(0))),p.each(this.children,function(e){e.updateElement(this.el||t)})},E.prototype.generate=function(){var e={id:this.id,keydash:this.keydash,elt:this.formElement,schema:this.schemaElement,node:this,value:c(this.value)?this.value:"",escape:s},t=null;this.ownerTree.formDesc.onBeforeRender&&this.ownerTree.formDesc.onBeforeRender(e,this),this.view.onBeforeRender&&this.view.onBeforeRender(e,this),t=this.template?this.template:this.formElement&&this.formElement.template?this.formElement.template:this.view.template,!1!==this.fieldtemplate&&(this.fieldtemplate||this.view.fieldtemplate)&&(t=u.fieldTemplate(t)),this.parentNode&&this.parentNode.view&&this.parentNode.view.childTemplate&&(t=this.parentNode.view.childTemplate(t));var n="";return p.each(this.children,function(e){n+=e.generate()}),e.children=n,e.fieldHtmlClass="",this.ownerTree&&this.ownerTree.formDesc&&this.ownerTree.formDesc.params&&this.ownerTree.formDesc.params.fieldHtmlClass&&(e.fieldHtmlClass=this.ownerTree.formDesc.params.fieldHtmlClass),this.formElement&&void 0!==this.formElement.fieldHtmlClass&&(e.fieldHtmlClass=this.formElement.fieldHtmlClass),p.template(t,e,a)},E.prototype.enhance=function(){var n=this,e=null,t=null,i=p.clone(this.ownerTree.formDesc.tpldata)||{};this.formElement&&(this.view.onInsert&&this.view.onInsert({target:f(this.el)},this),e=this.handlers||this.formElement.handlers,(t=this.onInsert||this.formElement.onInsert)&&t({target:f(this.el)},this),e&&p.each(e,function(e,t){"insert"===t&&e({target:f(this.el)},this)},this),this.el&&(this.onChange&&f(this.el).bind("change",function(e){n.onChange(e,n)}),this.view.onChange&&f(this.el).bind("change",function(e){n.view.onChange(e,n)}),this.formElement.onChange&&f(this.el).bind("change",function(e){n.formElement.onChange(e,n)}),this.onClick&&f(this.el).bind("click",function(e){n.onClick(e,n)}),this.view.onClick&&f(this.el).bind("click",function(e){n.view.onClick(e,n)}),this.formElement.onClick&&f(this.el).bind("click",function(e){n.formElement.onClick(e,n)}),this.onKeyUp&&f(this.el).bind("keyup",function(e){n.onKeyUp(e,n)}),this.view.onKeyUp&&f(this.el).bind("keyup",function(e){n.view.onKeyUp(e,n)}),this.formElement.onKeyUp&&f(this.el).bind("keyup",function(e){n.formElement.onKeyUp(e,n)}),e&&p.each(e,function(t,e){"insert"!==e&&f(this.el).bind(e,function(e){t(e,n)})},this)),this.legendChild&&this.legendChild.formElement&&f(this.legendChild.el).bind("keyup",function(e){n.formElement&&n.formElement.legend&&n.parentNode&&(n.legend=x(n.formElement.legend,n.arrayPath),i.idx=0<n.arrayPath.length?n.arrayPath[n.arrayPath.length-1]+1:n.childPos+1,i.value=f(e.target).val(),n.legend=p.template(n.legend,i,h),f(n.parentNode.el).trigger("legendUpdated"))})),f(this.el).find("legend").off().click(function(e){e.preventDefault(),e.stopPropagation();var t=f(e.target).hasClass("fa")?f(e.target).parent():f(e.target),n=t.find("#caret"),i=n.hasClass("fa-caret-down")?"fa-caret-right":"fa-caret-down";n.removeClass().addClass("fa "+i),t.parent().children("div").slideToggle()}),f(this.el).children(".collapse").hide(),p.each(this.children,function(e){e.enhance()})},E.prototype.resetDeleteEvents=function(){var i=this;f(this.el).find("a._jsonform-array-deleteidx").off().click(function(e){var t=f(e.target).parent().attr("data-idx")||f(e.target).parent().parent().attr("data-idx"),n=i.getArrayBoundaries();if(t=parseInt(t,10),e.preventDefault(),e.stopPropagation(),0<n.minItems){if(i.children.length<n.minItems+2&&f(i.el).find("> span > a._jsonform-array-deletelast").addClass("disabled"),i.children.length<=n.minItems)return!1}else 1===i.children.length&&f(i.el).find("> span > a._jsonform-array-deletelast").addClass("disabled");i.deleteArrayItem(t),0<=n.maxItems&&t<=n.maxItems-1&&f(i.el).find("> span > a._jsonform-array-addmore").removeClass("disabled")})},E.prototype.insertArrayItem=function(e,t){var n=0;void 0===e&&(e=this.children.length);var i=this.childTemplate.clone();for(this.appendChild(i),i.resetValues(),n=this.children.length-2;e<=n;n--)this.children[n].moveValuesTo(this.children[n+1]);for(this.children[e].resetValues(),this.children[e].computeInitialValues(),n=e;n<this.children.length;n++)this.children[n].render(t);this.resetDeleteEvents(),f(i.el).find(".collapse").first().removeClass("collapse")},E.prototype.deleteArrayItem=function(e){var t=0;for(void 0===e&&(e=this.children.length-1),t=e;t<this.children.length-1;t++)this.children[t+1].moveValuesTo(this.children[t]),this.children[t].render(),f(this.children[t].el).find(".collapse").first().removeClass("collapse");this.removeChild(),this.resetDeleteEvents()},E.prototype.getArrayBoundaries=function(){if(!this.view||!this.view.array)return{minItems:-1,maxItems:-1};var l=function(e,n){var t=null,i=null,a={minItems:-1,maxItems:-1};return n=n||e,e.view&&e.view.array&&e!==n?a:e.key?(i=e.key.replace(/\[[0-9]+\]/g,"[]"),e!==n&&(i=i.replace(/\[\][^\[\]]*$/,"")),(t=b(e.ownerTree.formDesc.schema.properties,i))?{minItems:t.minItems||t.minLength||-1,maxItems:t.maxItems||t.maxLength||-1}:a):(p.each(e.children,function(e){var t=l(e,n);-1!==t.minItems&&(-1!==a.minItems?a.minItems=Math.max(a.minItems,t.minItems):a.minItems=t.minItems),-1!==t.maxItems&&(-1!==a.maxItems?a.maxItems=Math.min(a.maxItems,t.maxItems):a.maxItems=t.maxItems)}),a)};return l(this)};var o=function(){this.eventhandlers=[],this.root=null,this.formDesc=null};o.prototype.initialize=function(e){e=e||{},this.formDesc=p.clone(e),this.formDesc.prefix=this.formDesc.prefix||"jsonform-"+p.uniqueId(),this.formDesc.schema&&!this.formDesc.schema.properties&&(this.formDesc.schema={properties:this.formDesc.schema}),this.formDesc.form=this.formDesc.form||["*",{type:"actions",items:[{type:"submit",value:"Submit"}]}],this.formDesc.form=p.isArray(this.formDesc.form)?this.formDesc.form:[this.formDesc.form],this.formDesc.params=this.formDesc.params||{},this.root=new E,(this.root.ownerTree=this).root.view=u.elementTypes.root,this.buildTree(),this.computeInitialValues()},o.prototype.buildTree=function(){p.each(this.formDesc.form,function(e){if("*"===e){var t=p.clone(this.formDesc.schema.properties),n={};this.formDesc.schema.order&&p.each(this.formDesc.schema.order,function(e){this.root.appendChild(this.buildFromLayout({key:e})),delete t[e]},this),p.each(t,function(e,t){p.isUndefined(e.properties)?this.root.appendChild(this.buildFromLayout({key:t})):n[t]=e},this),p.each(n,function(e,t){this.root.appendChild(this.buildFromLayout({key:t}))},this)}else p.isString(e)&&(e={key:e}),this.root.appendChild(this.buildFromLayout(e))},this)},o.prototype.buildFromLayout=function(n,e){var t,i=null,a=new E,l=null;if(n.key&&this.formDesc.customFormItems){var r=this.formDesc.customFormItems[n.key];void 0!==r&&(r.key=n.key,n=r)}if((n=p.clone(n)).items&&(p.isArray(n.items)?n.items=p.map(n.items,p.clone):n.items=[p.clone(n.items)]),n.key){if(!(i=b(this.formDesc.schema.properties,n.key)))throw new Error('The JSONForm object references the schema key "'+n.key+'" but that key does not exist in the JSON schema');if(this.formDesc.onElementSchema&&this.formDesc.onElementSchema(n,i),n.name=n.name||n.key,n.title=n.title||i.title,n.inlinetitle=n.inlinetitle||i.inlinetitle,n.description=n.description||i.description,n.readOnly=n.readOnly||i.readOnly||n.readonly||i.readonly,n.id||(n.id=y(this.formDesc.prefix)+"-elt-"+n.key),n.allowEmpty&&(i._jsonform_allowEmpty=!0),n.type||("string"===i.type&&"color"===i.format?n.type="color":"number"!==i.type&&"integer"!==i.type&&"string"!==i.type&&"any"!==i.type||i.enum?"boolean"===i.type?n.type="checkbox":"object"===i.type?i.properties?n.type="fieldset":n.type="textarea":p.isUndefined(i.enum)?n.type=i.type:n.type="select":n.type="text"),!n.options&&i.enum&&(n.titleMap?n.options=p.map(i.enum,function(e){return{value:e,title:n.titleMap[e]||e}}):n.options=i.enum),"checkboxes"===n.type&&i.items){var s=i.items.enum;s&&(i.items._jsonform_checkboxes_as_array=!0),!s&&i.items[0]&&(s=i.items[0].enum)&&(i.items[0]._jsonform_checkboxes_as_array=!0)}if("object"===i.type){var o=p.clone(i.properties),d={};i.order&&p.each(i.order,function(e){a.appendChild(this.buildFromLayout({key:n.key+"."+e})),delete o[e]},this),p.each(o,function(e,t){"object"!==e.type?a.appendChild(this.buildFromLayout({key:n.key+"."+t})):d[t]=e},this),p.each(d,function(e,t){a.appendChild(this.buildFromLayout({key:n.key+"."+t}))},this)}}if(n.type||(n.type="none"),!(t=u.elementTypes[n.type]))throw new Error('The JSONForm contains an element whose type is unknown: "'+n.type+'"');if(i){if(!t.inputfield&&!t.array&&"selectfieldset"!==n.type&&"object"!==i.type)throw new Error('The JSONForm contains an element that links to an element in the JSON schema (key: "'+n.key+'") and that should not based on its type ("'+n.type+'")')}else if(t.inputfield&&"selectfieldset"!==n.type)throw new Error('The JSONForm defines an element of type "'+n.type+'" but no "key" property to link the input field to the JSON schema');return n.iddot=y(n.id||""),a.formElement=n,a.schemaElement=i,a.view=t,a.ownerTree=this,n.handlers||(n.handlers={}),a.view.array?(l=n.items?n.items[0]||n.items:n.key+"[]",p.isString(l)&&(l={key:l}),a.setChildTemplate(this.buildFromLayout(l))):n.items&&p.each(n.items,function(e){p.isString(e)&&(e={key:e}),a.appendChild(this.buildFromLayout(e))},this),a},o.prototype.computeInitialValues=function(){this.root.computeInitialValues(this.formDesc.value)},o.prototype.render=function(e){e&&(this.domRoot=e,this.root.render(),this.hasRequiredField()&&f(e).addClass("jsonform-hasrequired"))},o.prototype.forEachElement=function(n){var i=function(e){for(var t=0;t<e.children.length;t++)n(e.children[t]),i(e.children[t])};i(this.root)},o.prototype.validate=function(e){var t=u.getFormValue(this.domRoot),n=!1,i=this.formDesc;if(!1!==i.validate){var a=!1;if("object"!=typeof i.validate?r.JSONFormValidator&&(a=r.JSONFormValidator.createEnvironment("json-schema-draft-03")):a=i.validate,a){var l=a.validate(t,this.formDesc.schema);f(this.domRoot).jsonFormErrors(!1,i),l.errors.length&&(n||(n=[]),n=n.concat(l.errors))}}return n&&!e&&(i.displayErrors?i.displayErrors(n,this.domRoot):f(this.domRoot).jsonFormErrors(n,i)),{errors:n}},o.prototype.submit=function(t){var e=function(){return t&&(t.preventDefault(),t.stopPropagation()),!1},n=u.getFormValue(this.domRoot),i=this.formDesc,a=!1;if(this.forEachElement(function(e){a||e.view.onSubmit&&(a=!e.view.onSubmit(t,e))}),a)return e();var l=this.validate();return i.onSubmit&&!i.onSubmit(l.errors,n)?e():l.errors?e():!(!i.onSubmitValid||i.onSubmitValid(n))&&e()},o.prototype.hasRequiredField=function(){var n=function(e){if(!e)return null;if(e.required&&"boolean"!==e.type)return e;var t=p.find(e.properties,function(e){return n(e)});return t||(e.items&&(t=p.isArray(e.items)?p.find(e.items,function(e){return n(e)}):n(e.items))?t:void 0)};return n(this.formDesc.schema)},u.getFormValue=function(e){var t=f(e).data("jsonform-tree");return t?t.root.getFormValues():null},f.fn.jsonFormErrors=function(e,t){if(f(".error",this).removeClass("error"),f(".has-error",this).removeClass("has-error"),f(".warning",this).removeClass("warning"),f(".jsonform-errortext",this).hide(),e){for(var n=[],i=0;i<e.length;i++){var a=e[i].uri.replace(/.*#\//,"").replace(/\//g,".").replace(/\.([0-9]+)(?=\.|$)/g,"[$1]"),l=".jsonform-error-"+y(a.replace(/\./g,"---"));n.push(l);var r=e[i].type||"error";f(l,this).addClass(r),f(l+" > .jsonform-errortext",this).html(e[i].message).show()}n=n.join(",");var s=f(n).get(0);s&&s.scrollIntoView&&s.scrollIntoView(!0,{behavior:"smooth"})}},f.fn.jsonForm=function(e){var t=this;v=e.resourceId,g=e.ouId,i=e.slug,e=p.defaults({},e,{submitEvent:"submit"});var n=new o;return n.initialize(e),n.render(t.get(0)),e.transloadit&&t.append('<input type="hidden" name="params" value=\''+s(d.stringify(e.transloadit.params))+"'>"),t.data("jsonform-tree",n),e.submitEvent&&(t.unbind(e.submitEvent+".jsonform"),t.bind(e.submitEvent+".jsonform",function(e){n.submit(e)})),l(t),f(".expandable > div, .expandable > fieldset",t).hide(),f(".expandable > legend",t).click(function(){var e=f(this).parent();e.toggleClass("expanded"),f("> div",e).slideToggle(100)}),n},f.fn.jsonFormValue=function(){return u.getFormValue(this)},r.JSONForm=r.JSONForm||{util:{}},r.JSONForm.getFormValue=u.getFormValue,r.JSONForm.fieldTemplate=u.fieldTemplate,r.JSONForm.fieldTypes=u.elementTypes,r.JSONForm.getInitialValue=w,r.JSONForm.initializeTabs=l,r.JSONForm.util.getObjKey=u.util.getObjKey,r.JSONForm.util.setObjKey=u.util.setObjKey}("undefined"!=typeof exports,"undefined"!=typeof exports?exports:window,"undefined"!=typeof jQuery?jQuery:{fn:{}},"undefined"!=typeof _?_:null,JSON);